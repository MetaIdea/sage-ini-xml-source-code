;----------------------------------------------------------------------------------------------
;
; FILE: GondorBuildings.ini
;
;----------------------------------------------------------------------------------------------

;----------------------------------------------------------------------------------------------
;
;	Base gate template, note an instance of this type shouldn't be created, use a left or
;	right version instead.
;
;----------------------------------------------------------------------------------------------
;----------------------------------------------------------------------------------------------
Object GondorCastleGateL
        
        SelectPortrait = BPCastleWall
	; *** ART Parameters ***
	Draw = W3DScriptedModelDraw Draw_Wall
		OkToChangeModelColor = Yes

	    WallBoundsMesh = P1

		DefaultModelConditionState
			Model = GBCASTGATEL
		End
		
		ModelConditionState = WORLD_BUILDER
  			Model = GBCASTGATELW
  		End
  		  		
		ModelConditionState = BASE_BUILD
  			Model = GBCASTGATEL_A
  		End
		AnimationState = BASE_BUILD
			StateName = STATE_None
			Animation
				AnimationName = GBCASTGATEL_A.GBCASTGATEL_A
				AnimationMode = ONCE
                AnimationSpeedFactorRange = 2.0 2.5 ; keep range wide to avoid lockstep anims
			End
		End
		
		ModelConditionState = JUST_BUILT
  			Model = GBCASTGATEL_A
  		End
		AnimationState = JUST_BUILT
			StateName = STATE_None
			Animation
				AnimationName = GBCASTGATEL_A.GBCASTGATEL_A
				AnimationMode = MANUAL
			End
			Flags = START_FRAME_FIRST
		End
  		  		
		ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
			Model = GBCASTGATEL_UA  
		End
		AnimationState = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
			Animation
				AnimationName = GBCASTGATEL_UA.GBCASTGATEL_UA
				AnimationMode = MANUAL
			End
			Flags = START_FRAME_FIRST
			StateName = STATE_None
		End    

		ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED
			Model = GBCASTGATEL_A  
		End
		AnimationState = ACTIVELY_BEING_CONSTRUCTED
			Animation
				AnimationName = GBCASTGATEL_A.GBCASTGATEL_A
				AnimationMode = MANUAL
			End
			Flags = START_FRAME_FIRST
			StateName = STATE_None
		End    

;		IdleAnimationState
;			BeginScript
;				CurDrawableAllowToContinue()
;			EndScript
;		
;			; Don't want the entire anim to play.
;			Flags = START_FRAME_LAST
;			Animation
;			StateName		= STATE_None
;				AnimationName = GBCASTGATEL.GBCASTGATEL
;				AnimationMode = ONCE
;			End
;		End
		
		ModelConditionState  = DAMAGED UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTGATL_UD1
		End
		
		ModelConditionState  = DAMAGED
			Model         = GBCASTGATEL_D1  
		End
	    
		AnimationState = DAMAGED
			StateName		= STATE_None
	;      EnteringStateFX = FX_MinWallATransitionDamaged
		End

		; REALLYDAMAGED ----------------------------------------------------------------------------------------------------------------
		TransitionState = TRANS_U_IntoReallyDamaged
			EnteringStateFX		= FX_BuildingReallyDamaged
			Animation = D2
				AnimationName		= GBCASTGATL_UD2.GBCASTGATL_UD2
				AnimationMode		= ONCE
				AnimationBlendTime	= 0
			End
		End
		ModelConditionState  = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTGATL_UD2
		End
		AnimationState = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
			StateName			= STATE_ReallyDamaged
	 		Flags				= START_FRAME_LAST
       		Animation			= ReallyDamagedanimation
				AnimationName	= GBCASTGATL_UD2.GBCASTGATL_UD2
				AnimationMode	= ONCE
   			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "STATE_None" or Prev == "STATE_Rubble"
				then
					; Only play the really damaged anim if we havn't come from another really damaged.
					CurDrawableSetTransitionAnimState("TRANS_U_IntoReallyDamaged")
				end
			EndScript
		End
		
		ModelConditionState  = REALLYDAMAGED
			Model         = GBCASTGATEL_D2
		End
		AnimationState = REALLYDAMAGED
			StateName			= STATE_ReallyDamaged
       		Animation			= ReallyDamagedanimation
				AnimationName	= GBCASTGATEL_D2.GBCASTGATEL_D2
				AnimationMode	= ONCE
   			End
		End

		; RUBBLE ----------------------------------------------------------------------------------------------------------------
		TransitionState = TRANS_U_IntoRubble
			Animation = D3
				AnimationName		= GBCASTGATL_UD3.GBCASTGATL_UD3
				AnimationMode		= ONCE
				AnimationBlendTime	= 0
			End
		End
		ModelConditionState  = RUBBLE UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTGATL_UD3
		End
		AnimationState = RUBBLE UPGRADE_NUMENOR_STONEWORK
			StateName				= STATE_Rubble
			Flags					= START_FRAME_LAST
			;EnteringStateFX	= FX_WallDie	;this plays after the stone sink into the ground
			Animation				= Death
				AnimationName		= GBCASTGATL_UD3.GBCASTGATL_UD3
				AnimationMode		= MANUAL
				AnimationBlendTime	= 0
			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "STATE_ReallyDamaged" or Prev == "STATE_None" or Prev == "TRANS_U_IntoReallyDamaged"
				then
					; Only play the rubble anim if we havn't come from another rubble.
					CurDrawableSetTransitionAnimState("TRANS_U_IntoRubble")
				end
			EndScript
		End      
		
		ModelConditionState  = RUBBLE
			Model         = GBCASTGATEL_D3
		End
		AnimationState = RUBBLE
			StateName				= STATE_Rubble
			Animation				= Death
				AnimationName		= GBCASTGATEL_D3.GBCASTGATEL_D3
				AnimationMode		= ONCE
			End
			EnteringStateFX	= FX_WallDie
		End      

  		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
  			Model = GBCASTGATEL_U
  		End

  		AnimationState = UPGRADE_NUMENOR_STONEWORK
			StateName		= STATE_None
			EnteringStateFX = GenericBuildingUpgrade
		End

;		ModelConditionState  = POST_RUBBLE
;			Model         = None
;		End

;		ModelConditionState  = POST_COLLAPSE
;			Model         = None
;		End

	End
	
  
	; *** AUDIO Parameters ***

	VoiceSelect				= Gui_PlotSelect

	SoundOnDamaged			= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction

	UnitSpecificSounds
		UnderConstruction		= BuildingConstructionLoop  ; Built first time
		; UnderRepairFromDamage	= NoSound					; Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble	= BuildingConstructionLoop	; Repaired from completely destroyed (not used???)
	End

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:WallDie	Animation:GBCASTGATL_UD3.GBCASTGATL_UD3	Frames:0
	End


	; ***DESIGN parameters ***
	DisplayName		= OBJECT:GondorCastleGate
	EditorSorting	= STRUCTURE
	Side			= Men
	BuildTime		= CASTLE_WALL_REBUILD_TIME
	BuildCost		= CASTLE_WALL_REBUILD_COST

	ArmorSet
		Conditions	= None
		Armor		= GondorCastleWall
		DamageFX	= MinasWallADamageFX
	End
	

	; *** ENGINEERING Parameters ***  
	KindOf					= STRUCTURE IMMOBILE WALK_ON_TOP_OF_WALL CHUNK_VENDOR SELECTABLE NOT_AUTOACQUIRABLE ;;;should this get autoacquired, or not? NO! or attack move will fail to enter the gate!
	RadarPriority			= STRUCTURE
	KeepSelectableWhenDead	= Yes
	CommandSet				= GenericSelfRepairCommandSet
	
	Body				= ActiveBody ModuleTag_02
		MaxHealth		= GONDOR_CASTLE_WALL_HEALTH
		
		GrabObject = EntThrownBuildingRock
		GrabFX = FX_WallGrab
		GrabDamage = 490
		GrabOffset = X:16 Y:0
	End

        Behavior                  = BuildingBehavior BuildingModuleTag
           NightWindowName         = WINDOW_N01
        ;  FireWindowName          = WINDOW_F01
        ;  GlowWindowName			= WINDOW_G01
        ;  FireName				= FIRE01
        End
	
;    Behavior = SiegeDockingBehavior ModuleTag_SiegeDocking
;    End

	; Note that structures with "RUBBLE" states should not use DestroyDie; such buildings are 
	; never truly destroyed, even when reduced to zero health. Also note that garrisonable
	; buildings automatically stick around because GarrisonContain has it's own DieModule
;	Behavior = SlowDeathBehavior ModuleTag_SlowDeathWithoutRubble
;		DestructionDelay  = 3000
;	End
	Behavior = KeepObjectDie ModuleTag_IWantRubble
    End

  	Behavior = AttributeModifierAuraUpdate ModuleTag_WallBonus
		StartsActive	= Yes ;If no, requires upgrade to turn on.
		BonusName		= WallBonus
		RefreshDelay	= 2000
		ObjectFilter	= ALL -MACHINE
		;Range			= 120		; Range is overridden to affect people on us since we are a wall
		;TargetEnemy		= Yes	; Alliances are ignored to affect people on us since we are a wall
	End	

 	Behavior = GettingBuiltBehavior ModuleTag_GettingBuilt
		SelfBuildingLoop = BuildingConstructionLoop ; Only played if we DON'T spawn a worker
		SelfRepairFromDamageLoop  = NoSound         ; This doesn't cause an animation, so don't bother playing a sound
		SelfRepairFromRubbleLoop  = BuildingConstructionLoop
		SpawnTimer = -1.0 ; Negative means no 'autoheal'
		RebuildTimeSeconds = CASTLE_WALL_REBUILD_TIME
	End

    Behavior = CastleMemberBehavior ModuleTag_CMB
		CountsForEvaCastleBreached = Yes
    End 

	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_NumenorStonework
		AttributeModifier		= NumenorStonework_Bonus
		CustomAnimAndDuration	= AnimState:UPGRADE_NUMENOR_STONEWORK AnimTime:0
	End

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag2
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= StandardWallDeath
	End	

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag1
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= CastleWallDeath
	End	

	Geometry						= BOX
	GeometryMajorRadius				= 24.0
	GeometryMinorRadius				= 55.0
	GeometryHeight					= 52.0
	GeometryOffset					= X:-3 Y:55 Z:0
	
	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius				= 33.0
	GeometryMinorRadius				= 0
	GeometryHeight					= 52.0
	GeometryOffset					= X:-12 Y:105 Z:0
	GeometryRotationAnchorOffset	= X:375.0 Y:0
	GeometryIsSmall					= No
	
	GeometryContactPoint			= X:35		Y: 25		Z:0 Grab
	GeometryContactPoint			= X:21		Y: 25		Z:0 
	GeometryContactPoint			= X:21		Y: 60		Z:52 
	GeometryContactPoint			= X:21		Y: 95		Z:0  
	GeometryContactPoint			= X:31		Y: 95		Z:0 Grab 
	GeometryContactPoint			= X:-50		Y: 95		Z:0 Grab
	GeometryContactPoint			= X:-30		Y: 95		Z:0 
	GeometryContactPoint			= X:-21		Y: 60		Z:52  
	GeometryContactPoint			= X:-21		Y: 25		Z:0 
	GeometryContactPoint			= X:-40		Y: 25		Z:0 Grab

	Shadow							= SHADOW_VOLUME
End

;----------------------------------------------------------------------------------------------
Object GondorCastleGateR
        
        SelectPortrait = BPCastleWall
	; *** ART Parameters ***
	Draw = W3DScriptedModelDraw Draw_Wall
		OkToChangeModelColor = Yes

	    WallBoundsMesh = P1

		DefaultModelConditionState
			Model = GBCASTGATER
		End

		ModelConditionState = WORLD_BUILDER
  			Model = GBCASTGATERW
  		End

		ModelConditionState = BASE_BUILD
  			Model = GBCASTGATER_A
  		End
		AnimationState = BASE_BUILD
			StateName = STATE_None
			Animation
				AnimationName = GBCASTGATER_A.GBCASTGATER_A
				AnimationMode = ONCE
                AnimationSpeedFactorRange = 2.0 2.5 ; keep range wide to avoid lockstep anims
			End
		End
		
		ModelConditionState = JUST_BUILT
  			Model = GBCASTGATER_A
  		End
		AnimationState = JUST_BUILT
			StateName = STATE_None
			Animation
				AnimationName = GBCASTGATER_A.GBCASTGATER_A
				AnimationMode = MANUAL
			End
			Flags = START_FRAME_FIRST
		End		
		
		ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
			Model = GBCASTGATER_UA  
		End
		AnimationState = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
			Animation
				AnimationName = GBCASTGATER_UA.GBCASTGATER_UA
				AnimationMode = MANUAL
			End
			StateName = STATE_None
			Flags = START_FRAME_FIRST
		End    

		ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED
			Model = GBCASTGATER_A  
		End
		AnimationState = ACTIVELY_BEING_CONSTRUCTED
			Animation
				AnimationName = GBCASTGATER_A.GBCASTGATER_A
				AnimationMode = MANUAL
			End
			StateName = STATE_None
			Flags = START_FRAME_FIRST
		End    

;		IdleAnimationState
;			BeginScript
;				CurDrawableAllowToContinue()
;			EndScript
;		
;			; Don't want the entire anim to play.
;			Flags = START_FRAME_LAST
;			StateName		= STATE_None
;			Animation
;				AnimationName = GBCASTGATER.GBCASTGATER
;				AnimationMode = ONCE
;			End
;		End
		
		ModelConditionState  = DAMAGED UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTGATR_UD1  
		End
		
		ModelConditionState  = DAMAGED
			Model         = GBCASTGATER_D1  
		End
	    
		AnimationState = DAMAGED
			StateName		= STATE_None
;			EnteringStateFX = FX_MinWallATransitionDamaged
		End

		; REALLYDAMAGED ----------------------------------------------------------------------------------------------------------------
		TransitionState = TRANS_U_IntoReallyDamaged
			EnteringStateFX		= FX_BuildingReallyDamaged
			Animation = D2
				AnimationName		= GBCASTGATR_UD2.GBCASTGATR_UD2
				AnimationMode		= ONCE
				AnimationBlendTime	= 0
			End
		End
		ModelConditionState  = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTGATR_UD2
		End
		AnimationState = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
			StateName			= STATE_ReallyDamaged
 			Flags				= START_FRAME_LAST
       		Animation			= ReallyDamagedanimation
				AnimationName	= GBCASTGATR_UD2.GBCASTGATR_UD2
				AnimationMode	= ONCE
   			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "STATE_None" or Prev == "STATE_Rubble"
				then
					; Only play the really damaged anim if we havn't come from another really damaged.
					CurDrawableSetTransitionAnimState("TRANS_U_IntoReallyDamaged")
				end
			EndScript
		End

		ModelConditionState  = REALLYDAMAGED
			Model         = GBCASTGATER_D2
		End
		AnimationState = REALLYDAMAGED
			StateName			= STATE_ReallyDamaged
       		Animation			= ReallyDamagedanimation
				AnimationName	= GBCASTGATER_D2.GBCASTGATER_D2
				AnimationMode	= ONCE
   			End
		End

		; RUBBLE ----------------------------------------------------------------------------------------------------------------
		TransitionState = TRANS_U_IntoRubble
			Animation = D3
				AnimationName		= GBCASTGATR_UD3.GBCASTGATR_UD3
				AnimationMode		= ONCE
				AnimationBlendTime = 0
			End
		End
		ModelConditionState  = RUBBLE UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTGATR_UD3
		End
		AnimationState = RUBBLE UPGRADE_NUMENOR_STONEWORK
			StateName				= STATE_Rubble
			Flags					= START_FRAME_LAST
			;EnteringStateFX	= FX_WallDie	;this plays after the stone sink into the ground
			Animation				=	Death
				AnimationName		=	GBCASTGATR_UD3.GBCASTGATR_UD3
				AnimationMode		= MANUAL
				AnimationBlendTime	= 0
			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "STATE_ReallyDamaged" or Prev == "STATE_None" or Prev == "TRANS_U_IntoReallyDamaged"
				then
					; Only play the rubble anim if we havn't come from another rubble.
					CurDrawableSetTransitionAnimState("TRANS_U_IntoRubble")
				end
			EndScript
		End      

		ModelConditionState  = RUBBLE
			Model         = GBCASTGATER_D3
		End	    
		AnimationState = RUBBLE
			StateName				= STATE_Rubble
			Animation				=	Death
				AnimationName		=	GBCASTGATER_D3.GBCASTGATER_D3
				AnimationMode		=	ONCE
			End
			EnteringStateFX	= FX_WallDie
		End      
  		
  		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
  			Model = GBCASTGATER_U
  		End

  		AnimationState = UPGRADE_NUMENOR_STONEWORK
			StateName		= STATE_None
			EnteringStateFX = GenericBuildingUpgrade
		End

;		ModelConditionState  = POST_RUBBLE
;			Model         = None
;		End

;		ModelConditionState  = POST_COLLAPSE
;			Model         = None
;		End
	End
	
  
	; *** AUDIO Parameters ***

	VoiceSelect				= Gui_PlotSelect

	SoundOnDamaged			= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction

	UnitSpecificSounds
		UnderConstruction		= BuildingConstructionLoop  ; Built first time
		; UnderRepairFromDamage	= NoSound					; Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble	= BuildingConstructionLoop	; Repaired from completely destroyed (not used???)
	End

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:WallDie	Animation:GBCASTGATR_UD3.GBCASTGATR_UD3	Frames:0
	End


	; ***DESIGN parameters ***
	DisplayName		= OBJECT:GondorCastleGate
	EditorSorting	= STRUCTURE
	Side			= Men
	BuildTime		= CASTLE_WALL_REBUILD_TIME
	BuildCost		= CASTLE_WALL_REBUILD_COST

	ArmorSet
		Conditions	= None
		Armor		= GondorCastleWall
		DamageFX	= MinasWallADamageFX
	End
	

	; *** ENGINEERING Parameters ***  
	KindOf					= STRUCTURE IMMOBILE WALK_ON_TOP_OF_WALL CHUNK_VENDOR SELECTABLE NOT_AUTOACQUIRABLE ;;;should this get autoacquired, or not? NO! or attack move will fail to enter the gate!
	RadarPriority			= STRUCTURE
	KeepSelectableWhenDead	= Yes
	CommandSet				= GenericSelfRepairCommandSet
	
        Behavior                  = BuildingBehavior BuildingModuleTag
           NightWindowName         = WINDOW_N01
        ;  FireWindowName          = WINDOW_F01
        ;  GlowWindowName			= WINDOW_G01
        ;  FireName				= FIRE01
        End

	Body				= ActiveBody ModuleTag_02
		MaxHealth		= GONDOR_CASTLE_WALL_HEALTH
		
		GrabObject = EntThrownBuildingRock
		GrabFX = FX_WallGrab
		GrabDamage = 490
		GrabOffset = X:16 Y:0
	End

;    Behavior = SiegeDockingBehavior ModuleTag_SiegeDocking
;    End

	; Note that structures with "RUBBLE" states should not use DestroyDie; such buildings are 
	; never truly destroyed, even when reduced to zero health. Also note that garrisonable
	; buildings automatically stick around because GarrisonContain has it's own DieModule
;	Behavior = SlowDeathBehavior ModuleTag_SlowDeathWithoutRubble
;		DestructionDelay  = 3000
;	End
	Behavior = KeepObjectDie ModuleTag_IWantRubble
    End

 	Behavior = GettingBuiltBehavior ModuleTag_GettingBuilt
	    SelfBuildingLoop = BuildingConstructionLoop ; Only played if we DON'T spawn a worker
		SelfRepairFromDamageLoop  = NoSound         ; This doesn't cause an animation, so don't bother playing a sound
		SelfRepairFromRubbleLoop  = BuildingConstructionLoop
		SpawnTimer = -1.0 ; Negative means no 'autoheal'
		RebuildTimeSeconds = CASTLE_WALL_REBUILD_TIME
	End

	Behavior = ProductionUpdate ProductionUpdateModuleTag
		; nothing, but is required if we have any Object-level Upgrades!
	End

  	Behavior = AttributeModifierAuraUpdate ModuleTag_WallBonus
		StartsActive	= Yes ;If no, requires upgrade to turn on.
		BonusName		= WallBonus
		RefreshDelay	= 2000
		ObjectFilter	= ALL -MACHINE
		;Range			= 120		; Range is overridden to affect people on us since we are a wall
		;TargetEnemy		= Yes	; Alliances are ignored to affect people on us since we are a wall
	End	

	Behavior = CastleMemberBehavior ModuleTag_CMB
		CountsForEvaCastleBreached = Yes
	End 

	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_NumenorStonework
		AttributeModifier		= NumenorStonework_Bonus
		CustomAnimAndDuration	= AnimState:UPGRADE_NUMENOR_STONEWORK AnimTime:0
	End

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag2
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= StandardWallDeath
	End	

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag1
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= CastleWallDeath
	End	

	Geometry						= BOX
	GeometryMajorRadius				= 24.0
	GeometryMinorRadius				= 55.0
	GeometryHeight					= 52.0
	GeometryOffset					= X:-3 Y:-55 Z:0
	
	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius				= 33.0
	GeometryMinorRadius				= 0
	GeometryHeight					= 52.0
	GeometryOffset					= X:-12 Y:-105 Z:0
	
	GeometryRotationAnchorOffset	= X:375.0 Y:0
	GeometryIsSmall					= No
	
	GeometryContactPoint			= X:35		Y: -25		Z:0 Grab
	GeometryContactPoint			= X:21		Y: -25		Z:0 
	GeometryContactPoint			= X:21		Y: -60		Z:52 
	GeometryContactPoint			= X:21		Y: -95		Z:0  
	GeometryContactPoint			= X:31		Y: -95		Z:0 Grab 
	GeometryContactPoint			= X:-50		Y: -95		Z:0 Grab
	GeometryContactPoint			= X:-30		Y: -95		Z:0 
	GeometryContactPoint			= X:-21		Y: -60		Z:52  
	GeometryContactPoint			= X:-21		Y: -25		Z:0 
	GeometryContactPoint			= X:-40		Y: -25		Z:0 Grab

	
	Shadow							= SHADOW_VOLUME
End


;----------------------------------------------------------------------------------------------
Object GondorCastleBridge

	; *** ART Parameters ***
	Draw = W3DScriptedModelDraw ModuleTag_01


		RampMesh1 = P2
		RampMesh2 = P3
	    RaisedWallMesh = P1
	    
	                    		    
		DefaultModelConditionState
			Model = GBCastBrdg
;			ParticleSysBone   = glowbone01 TorchSmokeBlack
;			ParticleSysBone   = glowbone02 TorchGlow
;			ParticleSysBone   = glowbone03 TorchSmokeBlack
;			ParticleSysBone   = glowbone04 TorchGlow
		End
  		
	IdleAnimationState
		Animation
			AnimationName     = GBCastBrdg.GBCastBrdg
			AnimationMode     = MANUAL
			AnimationBlendTime = 0
        End
        Flags = START_FRAME_LAST
	End    

    ;------------Build Up States
    ModelConditionState   = BASE_BUILD
      Model               = GBCastBrdg
;      ParticleSysBone	  = NONE BuildingDoughnutCloud
      ParticleSysBone     = NONE BuildingContructDust
    End  
	AnimationState		  = BASE_BUILD
		Animation
			AnimationName = GBCastBrdg.GBCastBrdg
			AnimationMode = ONCE
			AnimationSpeedFactorRange = 2.0 2.5 ; keep range wide to avoid lockstep anims
		End
	End

	AnimationState		  = JUST_BUILT
		Animation
			AnimationName = GBCastBrdg.GBCastBrdg
			AnimationMode = MANUAL
			AnimationBlendTime = 0
		End
        Flags = START_FRAME_FIRST
	End    
	
    ModelConditionState  = DAMAGED UPGRADE_NUMENOR_STONEWORK
      Model         = GBCastBrdg_U_D1
    End
    ModelConditionState  = DAMAGED
      Model         = GBCastBrdg_D1
    End
    AnimationState = DAMAGED
    End

    ModelConditionState  = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
      Model         = GBCastBrdg_UD2
    End
    AnimationState = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
        Animation				=	ReallyDamagedanimation
			AnimationName		=	 GBCastBrdg_UD2.GBCastBrdg_UD2
			AnimationMode		=	ONCE
;           AnimationSpeedFactorRange = 0.5 0.5
   		End
    End	

    ModelConditionState  = REALLYDAMAGED
      Model         = GBCastBrdg_D2
    End
    AnimationState = REALLYDAMAGED
        Animation				=	ReallyDamagedanimation
			AnimationName		=	 GBCastBrdg_D2.GBCastBrdg_D2
			AnimationMode		=	ONCE
;           AnimationSpeedFactorRange = 0.5 0.5
   		End
    End	
    
    ModelConditionState  = RUBBLE UPGRADE_NUMENOR_STONEWORK
      Model         = GBCastBrdg_UD3  
;      ParticleSysBone emberBone01 TrebuchetImpactDebris
;      ParticleSysBone emberBone02 SmokeBuildingLarge
;      ParticleSysBone emberBone03 PCTMediumDust
    End
    AnimationState = RUBBLE UPGRADE_NUMENOR_STONEWORK
    	Animation				=	Death
			AnimationName		=	GBCastBrdg_UD3.GBCastBrdg_UD3
			AnimationMode		=	ONCE
;           AnimationSpeedFactorRange = 0.5 0.5
		End
		EnteringStateFX	= FX_WallDie
    End


	ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
      Model         = GBCastBrdg_U_D1
    End
	ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED
      Model         = GBCastBrdg_D1
    End


	AnimationState  = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
    	Animation				=	Death
			AnimationName		=	GBCastBrdg_UD3.GBCastBrdg_UD3
			AnimationMode		=	ONCE
		End
    End
	AnimationState  = ACTIVELY_BEING_CONSTRUCTED
    	Animation				=	Death
			AnimationName		=	GBCastBrdg_D3.GBCastBrdg_D3
			AnimationMode		=	ONCE
		End
    End




    ModelConditionState  = RUBBLE
      Model         = GBCastBrdg_D3  
;      ParticleSysBone emberBone01 TrebuchetImpactDebris
;      ParticleSysBone emberBone02 SmokeBuildingLarge
;      ParticleSysBone emberBone03 PCTMediumDust
    End
    AnimationState = RUBBLE
    	Animation				=	Death
			AnimationName		=	GBCastBrdg_D3.GBCastBrdg_D3
			AnimationMode		=	ONCE
;           AnimationSpeedFactorRange = 0.5 0.5
		End
		EnteringStateFX	= FX_WallDie
    End
		
		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
  			Model = GBCastBrdg_U
;			ParticleSysBone   = glowbone01 TorchSmokeBlack
;			ParticleSysBone   = glowbone02 TorchGlow
;			ParticleSysBone   = glowbone03 TorchSmokeBlack
;			ParticleSysBone   = glowbone04 TorchGlow
  		End

  		AnimationState = UPGRADE_NUMENOR_STONEWORK
			EnteringStateFX = GenericBuildingUpgrade
		End		

  	ModelConditionState  = POST_RUBBLE
		Model         = None
		ParticleSysBone NONE SmokeBuildingMediumRubble
	End
	ModelConditionState  = POST_COLLAPSE
		Model         = None
		ParticleSysBone NONE SmokeBuildingMediumRubble
	End

  End

  ; *** AUDIO Parameters ***

	SoundOnDamaged			= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	;VoiceSelectUnderConstruction	= BuildingEvilVoiceSelectUnderConstruction


  ; ***DESIGN parameters ***
  DisplayName      = OBJECT:GondorCastleGate
  Side = Men
  EditorSorting = STRUCTURE
; Browser = CINEMATICS UNIT

  ArmorSet
    Conditions        = None
    Armor             = GondorCastleWall
    DamageFX          = MinasWallADamageFX
  End

  ; *** ENGINEERING Parameters ***  
;  KindOf                = STRUCTURE SELECTABLE IMMOBILE
;  RadarPriority = STRUCTURE
;  Body                  = ActiveBody ModuleTag_03
;    MaxHealth       = 2000.0
;  End
	KindOf					= STRUCTURE IMMOBILE CHUNK_VENDOR WALK_ON_TOP_OF_WALL SELECTABLE NOT_AUTOACQUIRABLE
	RadarPriority			= STRUCTURE	
	KeepSelectableWhenDead	= Yes

	Body					= ActiveBody ModuleTag_03
	
			MaxHealth				= 6000.0
			MaxHealthDamaged		= 3000.0
			MaxHealthReallyDamaged  = 1000.0
		GrabObject = EntThrownBuildingRock
		GrabFX = FX_WallGrab
		GrabDamage = 490
		GrabOffset = X:16 Y:0
	End

  ; Note that structures with "RUBBLE" states should not use DestroyDie; such buildings are 
  ; never truly destroyed, even when reduced to zero health. Also note that garrisonable
  ; buildings automatically stick around because GarrisonContain has it's own DieModule
;  Behavior = SlowDeathBehavior ModuleTag_SlowDeathWithoutRubble
;      DestructionDelay  = 5000
;  End
	Behavior = KeepObjectDie ModuleTag_IWantRubble
	End

    Behavior = CastleMemberBehavior ModuleTag_CMB
		CountsForEvaCastleBreached = No  ; Having the walkway over the gate destroyed doesn't actually let the enemy into the castle
    End 

	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_NumenorStonework
		AttributeModifier		= NumenorStonework_Bonus
		CustomAnimAndDuration	= AnimState:UPGRADE_NUMENOR_STONEWORK AnimTime:0
	End
	
	; These are bunched-up together on purpose
	BuildCost		= 0  ; for free, since this serves no purpose
  	CommandSet				= GenericSelfRepairCommandSet   ;
 	Behavior = GettingBuiltBehavior ModuleTag_GettingBuilt
	    SelfBuildingLoop = BuildingConstructionLoop ; Only played if we DON'T spawn a worker
		SelfRepairFromDamageLoop  = NoSound         ; This doesn't cause an animation, so don't bother playing a sound
		SelfRepairFromRubbleLoop  = BuildingConstructionLoop
		SpawnTimer = -1.0 ; Negative means no 'autoheal'
		RebuildTimeSeconds	= 15 ; nice and fast, so we don;t visually block the gateway
	End
  
  Geometry				= BOX
  GeometryMajorRadius   = 25.0
  GeometryMinorRadius   = 82.5 
  GeometryHeight        = 10.0
  GeometryOffset		= X:-5 Y:10 Z:60  
  
  AdditionalGeometry    = BOX
  GeometryMajorRadius   = 17.5
  GeometryMinorRadius   = 12.5 
  GeometryHeight        = 70.0
  GeometryOffset		= X:25 Y:70 Z:0  
      
;  AdditionalGeometry    = BOX
;  GeometryMajorRadius   = 37.5
;  GeometryMinorRadius   = 12.5 
;  GeometryHeight        = 20.0
;  GeometryOffset		= X:50 Y:70 Z:0  
  
  AdditionalGeometry    = BOX
  GeometryMajorRadius   = 17.5
  GeometryMinorRadius   = 12.5 
  GeometryHeight        = 70.0
  GeometryOffset		= X:25 Y:-70 Z:0  
      
;  AdditionalGeometry    = BOX
;  GeometryMajorRadius   = 37.5
;  GeometryMinorRadius   = 12.5 
;  GeometryHeight        = 20.0
;  GeometryOffset		= X:50 Y:-70 Z:0  
  
  
;	Geometry						= BOX
;	GeometryMajorRadius				= 32
;	GeometryMinorRadius				= 98.0
;	GeometryHeight					= -30
;	GeometryOffset					= X:0 Y:0 Z:53.0

	GeometryRotationAnchorOffset	= X:375.0 Y:0
	GeometryIsSmall					= No
	
	GeometryContactPoint			= X:70		Y: 72		Z:0 Grab
	GeometryContactPoint			= X:28		Y: 72		Z:0 
	GeometryContactPoint			= X:0		Y: 60		Z:70 
	GeometryContactPoint			= X:0		Y: -60		Z:70 
	GeometryContactPoint			= X:28		Y: -72		Z:0 
	GeometryContactPoint			= X:70		Y: -72		Z:0 Grab

	
	Shadow							= SHADOW_VOLUME
End


;----------------------------------------------------------------------------------------------
Object GondorCastleElevator

  SelectPortrait = BPCastleWall
  ; *** ART Parameters ***
  Draw = W3DScriptedModelDraw ModuleTag_01
		OkToChangeModelColor = Yes

		ExtraPublicBone = Elev01
		ExtraPublicBone = Elev02
		ExtraPublicBone = Elev03
		ExtraPublicBone = Elev04
;		ExtraPublicBone = Elev05

	    WallBoundsMesh = P1

    DefaultModelConditionState
      Model = GBCASTELEV
    End

		ModelConditionState = WORLD_BUILDER
  			Model = GBCASTELEVW
  		End
  		
	IdleAnimationState
		Animation
			AnimationName     = GBCASTELEV.GBCASTELEV
			AnimationMode     = MANUAL
			AnimationBlendTime = 0
        End
		StateName = STATE_None
        Flags = START_FRAME_LAST
	End    

    ;------------Build Up States
    ModelConditionState   = BASE_BUILD
      Model               = GBCASTELEV
;      ParticleSysBone	  = NONE BuildingDoughnutCloud
      ParticleSysBone     = NONE BuildingContructDust
    End  
	AnimationState		  = BASE_BUILD
		StateName = STATE_None
		Animation
			AnimationName = GBCASTELEV.GBCASTELEV
			AnimationMode = ONCE
			AnimationSpeedFactorRange = 2.0 2.5 ; keep range wide to avoid lockstep anims
		End
	End

	AnimationState		  = JUST_BUILT
		Animation
			AnimationName = GBCASTELEV.GBCASTELEV
			AnimationMode = MANUAL
			AnimationBlendTime = 0
		End
        Flags = START_FRAME_FIRST
		StateName = STATE_None
	End    

	; Explicit because of numenor upgrade.
	ModelConditionState = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
		Model = GBCASTELEV_UA
	End
	AnimationState		  = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
		Animation
			AnimationName = GBCASTELEV_UA.GBCASTELEV_UA
			AnimationMode = MANUAL
			AnimationBlendTime = 0
		End
		StateName = STATE_None
	    Flags = START_FRAME_FIRST
		;BeginScript
		;	CurDrawablePlaySound("GondorBarracksBeginConstruction")
		;EndScript
	End    

	ModelConditionState = ACTIVELY_BEING_CONSTRUCTED
		Model = GBCASTELEV
	End
	AnimationState		  = ACTIVELY_BEING_CONSTRUCTED
		Animation
			AnimationName = GBCASTELEV.GBCASTELEV
			AnimationMode = MANUAL
			AnimationBlendTime = 0
		End
		StateName = STATE_None
        Flags = START_FRAME_FIRST
		;BeginScript
		;	CurDrawablePlaySound("GondorBarracksBeginConstruction")
		;EndScript
	End    
		
    ModelConditionState  = DAMAGED UPGRADE_NUMENOR_STONEWORK
      Model         = GBCASTELEV_UD1
    End
    ModelConditionState  = DAMAGED
      Model         = GBCASTELEV_D1
    End
    
    AnimationState = DAMAGED
		StateName = STATE_None
;		EnteringStateFX = FX_MinWallATransitionDamaged
    End

	; REALLYDAMAGED ----------------------------------------------------------------------------------------------------------------
	TransitionState = TRANS_U_IntoReallyDamaged
		EnteringStateFX		= FX_BuildingReallyDamaged
		Animation = D2
			AnimationName		= GBCASTELEV_UD2.GBCASTELEV_UD2
			AnimationMode		= ONCE
			AnimationBlendTime	= 0
		End
	End
    ModelConditionState  = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
      Model         = GBCASTELEV_UD2
    End
	AnimationState = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
 		StateName				= STATE_ReallyDamaged
 		Flags					= START_FRAME_LAST
      	Animation				= ReallyDamagedanimation_U
			AnimationName		= GBCASTELEV_UD2.GBCASTELEV_UD2
			AnimationMode		= MANUAL
			AnimationBlendTime = 0
   		End
		BeginScript
			Prev = CurDrawablePrevAnimationState()
			if Prev == "STATE_None" or Prev == "STATE_Rubble"
			then
				; Only play the really damaged anim if we havn't come from another really damaged.
				CurDrawableSetTransitionAnimState("TRANS_U_IntoReallyDamaged")
			end
		EndScript
    End

    ModelConditionState  = REALLYDAMAGED
      Model         = GBCASTELEV_D2
    End
	AnimationState = REALLYDAMAGED
  		StateName				= STATE_ReallyDamaged
      	Animation				= ReallyDamagedanimation
			AnimationName		= GBCASTELEV_D2.GBCASTELEV_D2
			AnimationMode		= ONCE
   		End
    End

	; RUBBLE ----------------------------------------------------------------------------------------------------------------
	TransitionState = TRANS_U_IntoRubble
		Animation = D3
			AnimationName		= GBCASTELEV_UD3.GBCASTELEV_UD3
			AnimationMode		= ONCE
			AnimationBlendTime = 0
		End
		ParticleSysBone NONE Explosion3
		ParticleSysBone NONE ExplosiveMineSmoke02
	End
    ModelConditionState  = RUBBLE UPGRADE_NUMENOR_STONEWORK
      Model         = GBCASTELEV_UD3
    End
    AnimationState = RUBBLE UPGRADE_NUMENOR_STONEWORK
		StateName				= STATE_Rubble
		Flags					= START_FRAME_LAST
		Animation				= Death_U
			AnimationName		= GBCASTELEV_UD3.GBCASTELEV_UD3
			AnimationMode		= MANUAL
			AnimationBlendTime	= 0
		End
		BeginScript
			Prev = CurDrawablePrevAnimationState()
			if Prev == "STATE_ReallyDamaged" or Prev == "STATE_None" or Prev == "TRANS_U_IntoReallyDamaged"
			then
				; Only play the rubble anim if we havn't come from another rubble.
				CurDrawableSetTransitionAnimState("TRANS_U_IntoRubble")
			end
		EndScript
		;EnteringStateFX	= FX_WallDie
    End

   ModelConditionState  = RUBBLE
      Model         = GBCASTELEV_D3
      ParticleSysBone NONE Explosion3
      ParticleSysBone NONE ExplosiveMineSmoke02
    End    
    AnimationState = RUBBLE
		StateName				= STATE_Rubble
		Animation				= Death
			AnimationName		= GBCASTELEV_D3.GBCASTELEV_D3
			AnimationMode		= ONCE
		End
		EnteringStateFX	= FX_WallDie
    End
  		
	ModelConditionState = UPGRADE_NUMENOR_STONEWORK
  		Model = GBCASTELEV_U
  	End

  	AnimationState = UPGRADE_NUMENOR_STONEWORK
		EnteringStateFX = GenericBuildingUpgrade
	End		

;    ModelConditionState  = POST_RUBBLE
;		Model         = None
 ;   End

  ;  ModelConditionState  = POST_COLLAPSE
;		 Model         = None
 ;   End


  End


  ; *** AUDIO Parameters ***

	VoiceSelect			= Gui_PlotSelect

	SoundOnDamaged			= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction

	UnitSpecificSounds
		UnderConstruction		= BuildingConstructionLoop  ; Built first time
		; UnderRepairFromDamage	= NoSound					; Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble	= BuildingConstructionLoop	; Repaired from completely destroyed (not used???)
	End

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:WallDie		Animation:GBCASTELEV_UD3.GBCASTELEV_UD3	Frames:0
	End


  ; ***DESIGN parameters ***
  DisplayName      = OBJECT:GondorCastleElevator
  Side = Men
  EditorSorting = STRUCTURE
; Browser = CINEMATICS UNIT
	BuildTime		= CASTLE_WALL_REBUILD_TIME
	BuildCost		= CASTLE_WALL_REBUILD_COST

  ArmorSet
    Conditions        = None
    Armor             = GondorCastleWall
    DamageFX          = MinasWallADamageFX
  End
	
	; *** ENGINEERING Parameters ***  
	KindOf					= STRUCTURE IMMOBILE WALK_ON_TOP_OF_WALL CHUNK_VENDOR NOT_AUTOACQUIRABLE SELECTABLE
	RadarPriority			= STRUCTURE
	KeepSelectableWhenDead	= Yes
	CommandSet				= GenericSelfRepairCommandSet
	
	Body				= ActiveBody ModuleTag_02
		MaxHealth		  = GONDOR_CASTLE_WALL_HEALTH
		
		GrabObject = EntThrownBuildingRock
		GrabFX = FX_WallGrab
		GrabDamage = 490
		GrabOffset = X:16 Y:0
	End

    Behavior = KeepObjectDie ModuleTag_IWantRubble
    End

    Behavior = SiegeDockingBehavior ModuleTag_SiegeDocking
    End
 
 	Behavior = GettingBuiltBehavior ModuleTag_GettingBuilt
	    SelfBuildingLoop = BuildingConstructionLoop ; Only played if we DON'T spawn a worker
		SelfRepairFromDamageLoop  = NoSound         ; This doesn't cause an animation, so don't bother playing a sound
		SelfRepairFromRubbleLoop  = BuildingConstructionLoop
		SpawnTimer = -1.0 ; Negative means no 'autoheal'
		RebuildTimeSeconds = CASTLE_WALL_REBUILD_TIME
	End
   
	Behavior = DynamicPortalBehaviour Portal
		GenerateNow		= Yes
		ObjectFilter	= ANY +INFANTRY -MONSTER -MACHINE -CAVALRY -ARMY_OF_DEAD
		AllowEnemies	= Yes	; Normally, only allies can use this
		BonePrefix		= Elev
		NumberOfBones	= 4
		
		WayPoint		= Index:0	Type:PreClimb	; 0
		WayPoint		= Index:1	Type:PreClimb	; 1
		WayPoint		= Index:2	Type:Climb	; 2
		WayPoint		= Index:3	Type:Climb	; 3
		WayPoint		= Index:2	Type:Climb	; 4
		WayPoint		= Index:1	Type:Climb	; 5

		Link			= From:0 Via:4 Via:5 To:3	; up, to centre
		Link			= From:3 Via:1 Via:2 To:0	; down, from centre
	End


  	Behavior = AttributeModifierAuraUpdate ModuleTag_WallBonus
		StartsActive	= Yes ;If no, requires upgrade to turn on.
		BonusName		= WallBonus
		RefreshDelay	= 2000
		ObjectFilter	= ALL -MACHINE
		;Range			= 120		; Range is overridden to affect people on us since we are a wall
		;TargetEnemy		= Yes	; Alliances are ignored to affect people on us since we are a wall
	End	
	
    Behavior = CastleMemberBehavior ModuleTag_CMB
		CountsForEvaCastleBreached = Yes
    End 
	
	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_NumenorStonework
		AttributeModifier		= NumenorStonework_Bonus
		CustomAnimAndDuration	= AnimState:UPGRADE_NUMENOR_STONEWORK AnimTime:0
	End

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag2
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= StandardWallDeath
	End	

	Geometry						= BOX
	GeometryMajorRadius				= 24.0
	GeometryMinorRadius				= 70.0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-3 Y:0 Z:0
	
	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius				= 26.0
	GeometryMinorRadius				= 0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y:-80 Z:0
	
	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius				= 26.0
	GeometryMinorRadius				= 0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y:80 Z:0
	
	AdditionalGeometry				= BOX
	GeometryMajorRadius				= 15.0
	GeometryMinorRadius				= 14.0
	GeometryHeight					= 102.0
	GeometryOffset					= X:-30 Y:0 Z:0
	
	AdditionalGeometry				= BOX
	GeometryMajorRadius				= 18.0
	GeometryMinorRadius				= 1.0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y: 98 Z:0
	GeometryName					= Bookend
	
	AdditionalGeometry				= BOX
	GeometryMajorRadius				= 18.0
	GeometryMinorRadius				= 1.0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y:-98 Z:0
	GeometryName					= Bookend
	
	
	GeometryIsSmall					= No
	GeometryRotationAnchorOffset	= X:375.0 Y:0.0
	Shadow							= SHADOW_VOLUME
	
	GeometryContactPoint			= X: 0  Y: 0  Z:53 Swoop
	GeometryContactPoint			= X: 30 Y:-70 Z:0 Grab
	GeometryContactPoint			= X:-20 Y:-60 Z:0 Grab
	GeometryContactPoint			= X: 23 Y:-40 Z:0 Grab
	GeometryContactPoint			= X:-40 Y:-40 Z:0 Grab
	GeometryContactPoint			= X: 33 Y: 40 Z:0 Grab
	GeometryContactPoint			= X:-40 Y: 40 Z:0 Grab
	GeometryContactPoint			= X: 30 Y: 60 Z:0 Grab
	GeometryContactPoint			= X:-40 Y: 70 Z:0 Grab

End     

;----------------------------------------------------------------------------------------------
Object GondorCastleUpgrade

	; *** ART Parameters ***
	SelectPortrait         = BPCastleWall
	Draw = W3DScriptedModelDraw Draw_Trebuchet
		OkToChangeModelColor = Yes

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth = No

		ExtraPublicBone = Treb01
		ExtraPublicBone = Treb02

		DefaultModelConditionState
			Model				= GBCASTTREB
		End

		ModelConditionState = WORLD_BUILDER
  			Model = GBCASTTREBW
  		End

		IdleAnimationState
			StateName = Complete
			BeginScript
				CurDrawableHideModule("Draw_Trebuchet")
			EndScript
		End


		ModelConditionState  = SOLD
			Model = GBCASTTREB  
		End
		AnimationState = SOLD
			Animation
				AnimationName = GBCASTTREB.GBCASTTREB
				AnimationMode = ONCE_BACKWARDS
				AnimationSpeedFactorRange = 3.0 3.0
			End
			Flags = START_FRAME_LAST
			EnteringStateFX = FX_BuildingContructDustCastles
		End



		ModelConditionState  = UPGRADE_TREBUCHET DAMAGED
			Model         = GBCASTTREB_D1  
		End
	    
		AnimationState = UPGRADE_TREBUCHET DAMAGED
	;      EnteringStateFX = FX_MinWallATransitionDamaged
		End

		ModelConditionState  = UPGRADE_TREBUCHET REALLYDAMAGED
			Model         = GBCASTTREB_D2
		End
		
		AnimationState = UPGRADE_TREBUCHET REALLYDAMAGED
       		Animation				=	ReallyDamagedanimation
				AnimationName		=	 GBCASTTREB_D2.GBCASTTREB_D2
				AnimationMode		=	ONCE
   			End
	;        EnteringStateFX = FX_MinWallATransitionReallyDamaged
		End

		ModelConditionState  = UPGRADE_TREBUCHET RUBBLE
		Model         = GBCASTTREB_D3
		End
	    
		AnimationState = UPGRADE_TREBUCHET RUBBLE
			StateName = Complete
			Animation				=	Death
				AnimationName		=	GBCASTTREB_D3.GBCASTTREB_D3
				AnimationMode		=	ONCE
			End
	;        EnteringStateFX = FX_MinWallATransitionRubble
			EnteringStateFX	= FX_WallDie
		End      

		ModelConditionState  = UPGRADE_TREBUCHET POST_RUBBLE
			Model         = None
		End

		ModelConditionState  = UPGRADE_TREBUCHET POST_COLLAPSE
			Model         = None
		End		
		
		TransitionState = TRANS_IdleToBuild
			Animation
				AnimationName				= GBCASTTREB.GBCASTTREB
				AnimationMode				= ONCE
				AnimationSpeedFactorRange	= GONDOR_WALLTREBUCHET_BUILD_SPEED GONDOR_WALLTREBUCHET_BUILD_SPEED
			End
			EnteringStateFX = FX_BuildingContructDustCastles
		End

		AnimationState = UPGRADE_TREBUCHET
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "Complete" then CurDrawableSetTransitionAnimState("TRANS_IdleToBuild") end
			EndScript
			Flags = START_FRAME_LAST
			Animation
				AnimationName = GBCASTTREB.GBCASTTREB
				AnimationMode = ONCE
			End
		End
	
	End
		
	;----------------------------------------------------------------------------------------------
;;
;;	Newly-created field: the OverrideTooltip field! Notes
;;
;;		So this field has limitations, first and foremost being that it should
;;	only be applied to one drawModule.  When objects are drawn, all drawModules are used; so
;;	if you add OverrideTooltips to multiple drawModules, the lowest one (defined in the ini)
;;	will always take precedence over any others.
;;
;;		ReferenceDisplayName is a keyword to the drawable which tells it to ... reference the
;;	DisplayName of the object.
;;
	Draw = W3DScriptedModelDraw Draw_Picker

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth = No
	
		DefaultModelConditionState
			Model = GBCASTWallOB
		End
		
	End
	
	;----------------------------------------------------------------------------------------------
	Draw = W3DScriptedModelDraw Draw_Decal

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth = No
	
		; USER_1 - elven
		; USER_2 - dwarven
		; USER_3 - mordor
		; USER_4 - isengard
		; USER_5 - wild

		DefaultModelConditionState
			Model = GBCASTWallBF
		End
		
		ModelConditionState = USER_1
			Model = GBCASTWallBF
			Texture = GBFoundation.tga EBFoundation.tga
		End
		ModelConditionState = USER_2
			Model = GBCASTWallBF
			Texture = GBFoundation.tga DBFoundation.tga
		End
		ModelConditionState = USER_3
			Model = GBCASTWallBF
			Texture = GBFoundation.tga Mbfs01.tga
		End
		ModelConditionState = USER_4
			Model = GBCASTWallBF
			Texture = GBFoundation.tga IBFoundation.tga
		End
		ModelConditionState = USER_5
			Model = GBCASTWallBF
			Texture = GBFoundation.tga WBFoundation.tga
		End
		ModelConditionState = USER_6
			Model = GBCASTWallBF
			Texture = KBFoundation.tga WBFoundationP.tga
		End


		IdleAnimationState
			BeginScript
				CurDrawableShowModule("Draw_Decal")
				CurDrawableShowModule("Draw_Picker")
			EndScript
		End
		
		AnimationState  = JUST_BUILT
			BeginScript
				CurDrawableHideModule("Draw_Decal")
				CurDrawableShowModule("Draw_Picker")
			EndScript
		End

		AnimationState  = SOLD
			BeginScript
				CurDrawableHideModule("Draw_Decal"); since the command is not yet available
			EndScript
		End

		AnimationState  = RUBBLE
			BeginScript
				CurDrawableHideModule("Draw_Decal")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End
		
		AnimationState  = UPGRADE_POSTERN_GATE
			BeginScript
				CurDrawableShowModule("Draw_PosternGate")
				CurDrawableShowModule("Draw_Decal")			; Don't want to hide the decal cause this would give away our stealthed gate.
				;			
				CurDrawableHideModule("Draw_Tower")
				CurDrawableHideModule("Draw_Trebuchet")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End
		
		AnimationState  = UPGRADE_TREBUCHET
			BeginScript
				CurDrawableShowModule("Draw_Trebuchet")
				;			
				CurDrawableHideModule("Draw_Decal")
				CurDrawableHideModule("Draw_PosternGate")
				CurDrawableHideModule("Draw_Tower")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End
		
		AnimationState  = UPGRADE_GARRISON
			BeginScript
				CurDrawableShowModule("Draw_Tower")
				;			
				CurDrawableHideModule("Draw_Decal")
				CurDrawableHideModule("Draw_PosternGate")
				CurDrawableHideModule("Draw_Trebuchet")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End

	End

	;----------------------------------------------------------------------------------------------
	Draw = W3DScriptedModelDraw Draw_PosternGate

		ExtraPublicBone = Post01
		ExtraPublicBone = Post02
		ExtraPublicBone = Post03
		ExtraPublicBone = Post04

		DefaultModelConditionState
			Model				= GBCASTPOST
		End

		IdleAnimationState
			BeginScript
				CurDrawableHideModule("Draw_PosternGate")
			EndScript
		End


		ModelConditionState  = SOLD
			Model = GBCASTPOST  
		End
		AnimationState = SOLD
			Animation
				AnimationName = GBCASTPOST.GBCASTPOST
				AnimationMode = ONCE_BACKWARDS
				AnimationSpeedFactorRange = 3.0 3.0
			End
			Flags = START_FRAME_LAST
			EnteringStateFX = FX_BuildingContructDustCastlesCentre
		End


		ModelConditionState  = UPGRADE_POSTERN_GATE DAMAGED
			Model         = GBCASTPOST_D1  
		End
	    
		AnimationState = UPGRADE_POSTERN_GATE DAMAGED
	;      EnteringStateFX = FX_MinWallATransitionDamaged
		End

		ModelConditionState  = UPGRADE_POSTERN_GATE REALLYDAMAGED
		Model         = GBCASTPOST_D2
		End
		AnimationState = UPGRADE_POSTERN_GATE REALLYDAMAGED
	;        EnteringStateFX = FX_MinWallATransitionReallyDamaged
		End

		ModelConditionState  = UPGRADE_POSTERN_GATE RUBBLE
		Model         = GBCASTPOST_D3
		End
	    
		AnimationState = UPGRADE_POSTERN_GATE RUBBLE
			Animation				=	Death
				AnimationName		=	GBCASTPOST_D3.GBCASTPOST_D3
				AnimationMode		=	ONCE
			End
	;        EnteringStateFX = FX_MinWallATransitionRubble
			EnteringStateFX	= FX_WallDie
		End      

		ModelConditionState  = UPGRADE_POSTERN_GATE POST_RUBBLE
			Model         = None
		End

		ModelConditionState  = UPGRADE_POSTERN_GATE POST_COLLAPSE
			Model         = None
		End		
		

		AnimationState = UPGRADE_POSTERN_GATE
			Animation
				AnimationName = GBCASTPOST.GBCASTPOST
				AnimationMode = ONCE
			End
			EnteringStateFX = FX_BuildingContructDustCastlesCentre
		End
	
	End
		
	;----------------------------------------------------------------------------------------------
	Draw = W3DScriptedModelDraw Draw_Tower

		ExtraPublicBone = Arrow_01
		ExtraPublicBone = Arrow_02
		ExtraPublicBone = Arrow_03
		ExtraPublicBone = Arrow_04
		ExtraPublicBone = Arrow_05
		ExtraPublicBone = Arrow_06
		ExtraPublicBone = Arrow_07
		ExtraPublicBone = Arrow_08
		ExtraPublicBone = Arrow_09
		ExtraPublicBone = Arrow_10
		ExtraPublicBone = Arrow_11
		ExtraPublicBone = Arrow_12

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth = No

		DefaultModelConditionState
			Model				= GBCASTTOWR
			WeaponLaunchBone    = PRIMARY ARROW_
		End
		
		; This idle state is required simply to make sure the tower visual
		; mesh is invisible so we can't pick it when it's underground.
		; The actual state is not needed.
		IdleAnimationState
			StateName = Complete
			BeginScript
				CurDrawableHideModule("Draw_Tower")
			EndScript
		End
		
		ModelConditionState  = SOLD
			Model = GBCASTTOWR
		End
		AnimationState = SOLD
			Animation
				AnimationName = GBCASTTOWR.GBCASTTOWR
				AnimationMode = ONCE_BACKWARDS
				AnimationSpeedFactorRange = 3.0 3.0
			End
			Flags = START_FRAME_LAST
			EnteringStateFX = FX_BuildingContructDustCastles
		End
		
		
		
		
		ModelConditionState  = UPGRADE_GARRISON DAMAGED
			Model         = GBCASTTOWR_D1
		End
	    
		AnimationState = UPGRADE_GARRISON DAMAGED
	;      EnteringStateFX = FX_MinWallATransitionDamaged
		End

		ModelConditionState  = UPGRADE_GARRISON REALLYDAMAGED
			Model         = GBCASTTOWR_D2
		End
		
		AnimationState = UPGRADE_GARRISON REALLYDAMAGED
       		Animation				=	ReallyDamagedanimation
				AnimationName		=	 GBCASTTOWR_D2.GBCASTTOWR_D2
				AnimationMode		=	ONCE
  			End
	;        EnteringStateFX = FX_MinWallATransitionReallyDamaged
		End

		ModelConditionState  = UPGRADE_GARRISON RUBBLE
			Model         = GBCASTTOWR_D3
		End
	    
		AnimationState = UPGRADE_GARRISON RUBBLE
			StateName = Complete
			Animation				=	Death
				AnimationName		=	GBCASTTOWR_D3.GBCASTTOWR_D3
				AnimationMode		=	ONCE
			End
			EnteringStateFX	= FX_WallDie
		End      

		ModelConditionState  = UPGRADE_GARRISON POST_RUBBLE
			Model         = None
		End

		ModelConditionState  = UPGRADE_GARRISON POST_COLLAPSE
			Model         = None
		End		

		TransitionState				=	TRANS_IdleToBuild
			Animation
				AnimationName				= GBCASTTOWR.GBCASTTOWR
				AnimationMode				= ONCE
				AnimationSpeedFactorRange	= GONDOR_BATTLETOWER_BUILD_SPEED GONDOR_BATTLETOWER_BUILD_SPEED
			End
			EnteringStateFX = FX_BuildingContructDustCastles
		End

		; Just play the last frame, so we don't get the build anim again.
		AnimationState = UPGRADE_GARRISON
			
			; If we're complete then transition via showing and build anim.
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "Complete" then CurDrawableSetTransitionAnimState("TRANS_IdleToBuild") end
			EndScript
		
			Flags = START_FRAME_LAST
			Animation
				AnimationName = GBCASTTOWR.GBCASTTOWR
				AnimationMode = ONCE
			End
		End

	End


	;----------------------- AUDIO -------------------------

	VoiceSelect				= Gui_PlotSelect

	SoundOnDamaged			= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction

	;UnitSpecificSounds
		; UnderConstruction	= BuildingConstructionLoop ; Useless, this is never actually under construction, just being upgraded
	;End

	; Change selection sounds based on upgrades
	ClientBehavior = UpgradeSoundSelectorClientBehavior ModuleTag_UpgradeSoundSelector
		SoundUpgrade = Upgrade_PosternGate								; EVERYTHING on this line must be present
			ExcludedUpgrades = Upgrade_OpenGarrison Upgrade_TrebuchetTurret		; NOTHING on this line can be present
			VoiceSelect = GondorPosternGateSelect
		End
		
		SoundUpgrade = Upgrade_OpenGarrison								; EVERYTHING on this line must be present
			ExcludedUpgrades = Upgrade_PosternGate Upgrade_TrebuchetTurret		; NOTHING on this line can be present
			VoiceSelect = GondorBattleTowerSelect
		End

		SoundUpgrade = Upgrade_TrebuchetTurret							; EVERYTHING on this line must be present
			ExcludedUpgrades = Upgrade_PosternGate Upgrade_OpenGarrison			; NOTHING on this line can be present
			VoiceSelect = GondorArmorySelect
		End
	End

	
	; ***DESIGN parameters ***
	DisplayName		= OBJECT:GondorCastleWallUpgrade
	EditorSorting	= STRUCTURE
	Side			= Men
	IsTrainable		= No

	ArmorSet
		Conditions	= None
		Armor		= GondorCastleWallUpgrade
		DamageFX	= MinasWallADamageFX
	End
	ArmorSet
		Conditions	= AS_TOWER
		Armor		= GondorCastleWallUpgradeAsTower
		DamageFX	= MinasWallADamageFX
	End


	WeaponSet
		Conditions			= None
	End
	WeaponSet
		Conditions			= PLAYER_UPGRADE
		Weapon				= PRIMARY CastleWallUpgradeBow
		AutoChooseSources	= PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI
	End
	
	
	Behavior = ProductionUpdate ProductionUpdateModuleTag
		; nothing, but is required if we have any Object-level Upgrades!
	End
	
	
	Body				= ActiveBody ModuleTag_02
		MaxHealth		= GONDOR_CASTLE_WALL_UPGRADE_HEALTH
	End

;	Behavior = GarrisonUpgrade TheGarrisonUpgrade
;		TriggeredBy			= Upgrade_OpenGarrison
;		ConflictsWith		= Upgrade_PosternGate Upgrade_TrebuchetTurret
;	End
	Behavior = WeaponSetUpgrade ModuleTag_Add5ArchersToAllKeepsAndBattleTowers
		TriggeredBy			= Upgrade_OpenGarrison
		ConflictsWith		= Upgrade_PosternGate Upgrade_TrebuchetTurret
	End
	Behavior = CommandSetUpgrade TheGarrisonCommandSet
		TriggeredBy			= Upgrade_OpenGarrison
		ConflictsWith		= Upgrade_PosternGate Upgrade_TrebuchetTurret
		CommandSet			= SellableCommandSet
	End
	Behavior = AttributeModifierUpgrade DontShootWhilstBuilding
		TriggeredBy			= Upgrade_OpenGarrison
		ConflictsWith		= Upgrade_PosternGate Upgrade_TrebuchetTurret
		AttributeModifier	= PreventFromShooting
	End
	Behavior = AudioLoopUpgrade ModuleTag_GarrisonBuildLoop
		; Play a "build loop" while the garrison is building up
		TriggeredBy			= Upgrade_OpenGarrison
		ConflictsWith		= Upgrade_PosternGate Upgrade_TrebuchetTurret
		SoundToPlay			= BuildingConstructionLoop
		KillOnDeath         = Yes
		KillAfterMS			= 6166  ; Should match the length of the build-up animation [Or a little shorter since sounds take a little while to die]
	End
	Behavior = ArmorUpgrade ArmorUpgradeModuleTag1
		TriggeredBy			= Upgrade_OpenGarrison
	    ArmorSetFlag		= AS_TOWER
	End
	Behavior = TooltipUpgrade ModuleTag_GarrisonTooltip
		TriggeredBy				= Upgrade_OpenGarrison
		ConflictsWith			= Upgrade_PosternGate Upgrade_TrebuchetTurret
		DisplayName				= OBJECT:GondorBattleTower
		Description				= OBJECT:GondorBattleTowerDescription
	End
	
	
	; This isn't a geom upgrade, we just need something that doesn't do anything
	; to hook onto this upgrade.
	Behavior = GeometryUpgrade ModuleTag_FireArrows
		TriggeredBy			= Upgrade_BattleTowersToUseFireArrows
		ConflictsWith		= Upgrade_PosternGate Upgrade_TrebuchetTurret
	End
	
	Behavior = GeometryUpgrade ModueTag_TowerGeom
		TriggeredBy			= Upgrade_OpenGarrison
		ConflictsWith		= Upgrade_PosternGate Upgrade_TrebuchetTurret
		ShowGeometry		= TowerGeom
		HideGeometry		= TrebGeom DummyGeom
		CustomAnimAndDuration	= AnimState:UPGRADE_GARRISON AnimTime:0
	End
	
	Behavior = GeometryUpgrade ModueTag_TrebGeom
		TriggeredBy			= Upgrade_TrebuchetTurret
		ConflictsWith		= Upgrade_PosternGate Upgrade_OpenGarrison
		ShowGeometry		= TrebGeom
		HideGeometry		= TowerGeom DummyGeom
		WallBoundsMesh		= P2
		RampMesh1			= P3
		
		CustomAnimAndDuration	= AnimState:UPGRADE_TREBUCHET AnimTime:0
		
	End
	Behavior = AudioLoopUpgrade ModuleTag_TrebBuildLoop
		; Play a "build loop" while the treb is building up
		TriggeredBy			= Upgrade_TrebuchetTurret 
		ConflictsWith		= Upgrade_PosternGate Upgrade_OpenGarrison
		SoundToPlay			= BuildingConstructionLoop
		KillOnDeath         = Yes
		KillAfterMS			= 6166  ; Should match the length of the build-up animation [Or a little shorter since sounds take a little while to die]
	End
	
;	Behavior = CommandSetUpgrade ModueTag_TrebCommandSet
;		TriggeredBy			= Upgrade_TrebuchetTurret
;		ConflictsWith		= Upgrade_HasWallTrebuchet Upgrade_PosternGate Upgrade_OpenGarrison
;		CommandSet			= GondorCastleWallUpgradeCommandSetBuyNewTreb
;	End
	Behavior = ArmorUpgrade ArmorUpgradeModuleTag2
		TriggeredBy			= Upgrade_TrebuchetTurret
	    ArmorSetFlag		= AS_TOWER
	End
;	Behavior = CommandSetUpgrade ModueTag_TrebCommandSet3
;		TriggeredBy			= Upgrade_HasWallTrebuchet Upgrade_TrebuchetTurret
;		ConflictsWith		= Upgrade_OpenGarrison Upgrade_PosternGate
;		CommandSet			= SellableCommandSet
;		RequiresAllTriggers	= Yes
;	End
	
	Behavior = AttributeModifierUpgrade DontShootWhilstBuilding2	; Required for the buiding canceling - don't ask.
		TriggeredBy			= Upgrade_TrebuchetTurret
		AttributeModifier	= PreventFromShooting
	End
	Behavior = TooltipUpgrade ModuleTag_TrebuchetTooltip
		TriggeredBy				= Upgrade_TrebuchetTurret
		ConflictsWith			= Upgrade_OpenGarrison Upgrade_PosternGate
		DisplayName				= OBJECT:GondorTrebuchetOutcropping
		;Description			= OBJECT:GondorTrebuchetOutcroppingDescription
	End

;	Behavior = HordeGarrisonContain GarrisonContainModuleTag
;		ContainMax              = 2
;		PassengerFilter			= ANY +INFANTRY +HORDE -CAVALRY -SUMMONED -WildSpiderling -WildSpiderlingHorde
;		AllowAlliesInside       = Yes
;		AllowEnemiesInside      = Yes
;	    ObjectStatusOfContained = UNSELECTABLE CAN_ATTACK
;		EntryPosition			= X:45.0 Y:0.0 Z:60.0	; make sure we're aiming at the top of the wall
;		EntryOffset				= X:0.0 Y:0.0 Z:60.0	; make sure we're aiming at the top of the wall
;		ExitOffset				= X:0.0 Y:0.0 Z:60.0	; make sure we're aiming at the top of the wall
;		Enabled					= No
;		PassengerBonePrefix		= PassengerBone:ARROW_ KindOf:INFANTRY HORDE
;	End
	
	Behavior = DynamicPortalBehaviour PosternGatePortal
		TriggeredBy				= Upgrade_PosternGate
		ConflictsWith			= Upgrade_OpenGarrison Upgrade_TrebuchetTurret
		CustomAnimAndDuration	= AnimState:UPGRADE_POSTERN_GATE AnimTime:0
		ActivationDelaySeconds	= 7.0
		
		ObjectFilter	= POSTERNGATE_ALLOWABLE_OBJECTFILTER
		BonePrefix		= Post
		NumberOfBones	= 4
		WayPoint		= Index:0	Type:Walk	; 0
		WayPoint		= Index:1	Type:Walk	; 1
		WayPoint		= Index:2	Type:Walk	; 2
		WayPoint		= Index:3	Type:Walk	; 3
		WayPoint		= Index:2	Type:Walk	; 4
		WayPoint		= Index:1	Type:Walk	; 5
		Link			= From:0 Via:4 Via:5 To:3
		Link			= From:3 Via:1 Via:2 To:0
	End
	Behavior = CommandSetUpgrade ModueTag_PosternGateCommandSet
		TriggeredBy			= Upgrade_PosternGate
		ConflictsWith		= Upgrade_OpenGarrison Upgrade_TrebuchetTurret
		CommandSet			= SellableCommandSet
	End
	Behavior = AttributeModifierUpgrade DontShootWhilstBuilding3	; Required for the buiding canceling - don't ask.
		TriggeredBy			= Upgrade_PosternGate
		AttributeModifier	= PreventPosternGateFromShooting
	End	
	Behavior = AudioLoopUpgrade ModuleTag_GateBuildLoop
		; Play a "build loop" while the gate is building up
		TriggeredBy			= Upgrade_PosternGate
		ConflictsWith		= Upgrade_TrebuchetTurret Upgrade_OpenGarrison
		SoundToPlay			= BuildingConstructionLoop
		KillOnDeath         = Yes
		KillAfterMS			= 6166  ; Should match the length of the build-up animation [Or a little shorter since sounds take a little while to die]
	End
	Behavior = TooltipUpgrade ModuleTag_PosternGateTooltip
		TriggeredBy				= Upgrade_PosternGate
		ConflictsWith			= Upgrade_TrebuchetTurret Upgrade_OpenGarrison
		DisplayName				= OBJECT:GondorPosternGate
		;Description			= OBJECT:GondorPosternGateDescription
	End
	
	
;	Behavior = ObjectCreationUpgrade MakeTheFreeTreb
;		TriggeredBy		= Upgrade_TrebuchetTurret
;		ConflictsWith	= Upgrade_OpenGarrison Upgrade_PosternGate
;		Delay			= GONDOR_WALLTREBUCHET_CREATE_DELAY
;		GrantUpgrade	= Upgrade_HasWallTrebuchet
;		DestroyWhenSold = Yes
;		DeathAnimAndDuration = AnimState:DEATH_2 AnimTime:999999
;		Offset			= X:50.0 Y:0.0 Z:68
;	End
;	Behavior = ObjectCreationUpgrade MakeTheFreeTreb2
;		TriggeredBy		= Upgrade_HasWallTrebuchet
;		ConflictsWith	= Upgrade_OpenGarrison Upgrade_PosternGate
;		Delay			= 0.0
;		ThingToSpawn	= GondorTrebuchetWall
;		Offset			= X:50.0 Y:0.0 Z:68
;		FadeInTime		= 1000
;	End
;	Behavior = SlaveWatcherBehavior WatchTheTreb
;		RemoveUpgrade		=	Upgrade_HasWallTrebuchet			;when our slave dies, remove this upgrade, so we can get the upgrade again.
;	End

	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_NumenorStonework
		AttributeModifier		= NumenorStoneworkWallUpgrade_Bonus
	End



;	Behavior = GrantUpgradeCreate ModuleTag_ActLikeAnOldUpgrade
;		UpgradeToGrant			= Upgrade_TrebuchetTurret
;		GiveOnBuildComplete		= Yes							; The ExemptStatus UnderConstruction hack doesn't work on foundation buildings.
;	End
	Behavior = CommandSetUpgrade ModueTag_TrebCommandSet
		TriggeredBy				= Upgrade_TrebuchetTurret
		ConflictsWith			= Upgrade_HasWallTrebuchet Upgrade_PosternGate Upgrade_OpenGarrison
		CommandSet				= GenericBuyNewTrebCommandSet
	End
	Behavior = CommandSetUpgrade ModueTag_TrebSellCommandSet
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_TrebuchetTurret
		CommandSet				= SellableCommandSet
		RequiresAllTriggers		= Yes
	End
	Behavior = ObjectCreationUpgrade MakeTheFreeTreb
		TriggeredBy				= Upgrade_TrebuchetTurret
		Delay					= GONDOR_WALLTREBUCHET_CREATE_DELAY
		GrantUpgrade			= Upgrade_HasWallTrebuchet
		DestroyWhenSold			= Yes
		DeathAnimAndDuration	= AnimState:DEATH_2 AnimTime:999999
	End
	Behavior = ObjectCreationUpgrade ModuleTag_MordorTreb
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_MordorFaction
		RequiresAllTriggers		= Yes
		Delay					= 0.0
		ThingToSpawn			= MordorWallCatapult
		Offset					= X:50.0 Y:0.0 Z:68
		FadeInTime				= 600
	End
	Behavior = ObjectCreationUpgrade ModuleTag_MenTreb
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_MenFaction
		RequiresAllTriggers		= Yes
		Delay					= 0.0		
		ThingToSpawn			= GondorTrebuchetWall
		Offset					= X:50.0 Y:0.0 Z:68
		FadeInTime				= 600
	End
	Behavior = ObjectCreationUpgrade ModuleTag_ElvenTreb
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_ElfFaction
		RequiresAllTriggers		= Yes
		Delay					= 0.0		
		ThingToSpawn			= GondorTrebuchetWall
		Offset					= X:50.0 Y:0.0 Z:68
		FadeInTime				= 600
	End
	Behavior = ObjectCreationUpgrade ModuleTag_IsengardTreb
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_IsengardFaction
		RequiresAllTriggers		= Yes
		Delay					= 0.0		
		ThingToSpawn			= IsengardWallBallista
		Offset					= X:50.0 Y:0.0 Z:68
		FadeInTime				= 600
	End
	Behavior = ObjectCreationUpgrade ModuleTag_WildTreb
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_WildFaction
		RequiresAllTriggers		= Yes
		Delay					= 0.0		
		ThingToSpawn			= MordorWallCatapult
		Offset					= X:50.0 Y:0.0 Z:68
		FadeInTime				= 600
	End
	Behavior = ObjectCreationUpgrade ModuleTag_DwarfTreb
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_DwarfFaction
		RequiresAllTriggers		= Yes
		Delay					= 0.0		
		ThingToSpawn			= DwarvenWallCatapult
		Offset					= X:50.0 Y:0.0 Z:68
		FadeInTime				= 600
	End
	Behavior = ObjectCreationUpgrade ModuleTag_AngmarTreb
		TriggeredBy				= Upgrade_HasWallTrebuchet Upgrade_AngmarFaction
		RequiresAllTriggers		= Yes
		Delay					= 0.0		
		ThingToSpawn			= AngmarTrollSlingWall
		Offset					= X:0.0 Y:0.0 Z:60.0
		FadeInTime				= 600
	End
	Behavior = SlaveWatcherBehavior WatchTheTreb
		RemoveUpgrade			= Upgrade_HasWallTrebuchet				; when our slave dies, remove this upgrade, so we can get the upgrade again.
	End


	Behavior = CastleMemberBehavior ModuleTag_CMB
		StoreUpgradePrice = Yes ; We want to overload the refund price with any upgrades purchased.
		CountsForEvaCastleBreached = No   ; This is just the floating button
	End 
	
	Behavior = FoundationAIUpdate ModuleTag_FoundationAI
	End
	
	Behavior = WallUpgradeUpdate ModuleTag_Update
	End

	Behavior = AIUpdateInterface ModuleTag_SoWeCanUseWeapon
 		AutoAcquireEnemiesWhenIdle	= Yes
 		MoodAttackCheckRate			= 250
		AILuaEventsList				= GarrisonableFunctions
 	End

	Behavior = RefundDie ModuleTag_refund
		UpgradeRequired = Upgrade_MarketplaceUpgradeDefiance
		BuildingRequired = ANY +GondorMarketPlace
		RefundPercent = 50%
	End

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag1
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= CastleUpgradeDeath
	End
	
	Behavior = ModelConditionUpgrade Elven_Faction
		TriggeredBy					= Upgrade_ElfFaction
		AddConditionFlags			= USER_1
		Permanent					= Yes
	End
	Behavior = ModelConditionUpgrade Dwarven_Faction
		TriggeredBy					= Upgrade_DwarfFaction
		AddConditionFlags			= USER_2
		Permanent					= Yes
	End
	Behavior = ModelConditionUpgrade Mordor_Faction
		TriggeredBy					= Upgrade_MordorFaction
		AddConditionFlags			= USER_3
		Permanent					= Yes
	End
	Behavior = ModelConditionUpgrade Isengard_Faction
		TriggeredBy					= Upgrade_IsengardFaction
		AddConditionFlags			= USER_4
		Permanent					= Yes
	End
	Behavior = ModelConditionUpgrade Goblin_Faction
		TriggeredBy					= Upgrade_WildFaction
		AddConditionFlags			= USER_5
		Permanent					= Yes
	End

	Behavior = ModelConditionUpgrade Angmar_Faction
		TriggeredBy					= Upgrade_AngmarFaction
		AddConditionFlags			= USER_6
		Permanent					= Yes
	End


	KindOf							= STRUCTURE SELECTABLE IMMOBILE CHUNK_VENDOR CAN_ATTACK WALL_UPGRADE WALK_ON_TOP_OF_WALL NOT_AUTOACQUIRABLE IGNORE_FOR_VICTORY ;;;;;;;;  This needs to go in when being obscured by the wall is fixed -> ATTACK_NEEDS_LINE_OF_SIGHT GARRISON
	RadarPriority					= STRUCTURE
	CommandSet						= GondorCastleWallCommandSet
	VisionRange						= GONDOR_ARCHER_VISION_RANGE
	KeepSelectableWhenDead			= No
	
	GeometryRotationAnchorOffset	= X:375.0 Y:0.0
	GeometryIsSmall					= No

	Geometry						= BOX
	GeometryMajorRadius				= 1.0
	GeometryMinorRadius				= 1.0
	GeometryHeight					= 1.0
	GeometryName					= DummyGeom
	GeometryActive					= Yes

	AdditionalGeometry				= BOX
	GeometryMajorRadius				= 28.0
	GeometryMinorRadius				= 28.0
	GeometryHeight					= 80.0
	GeometryOffset					= X:54.0 Y:0.0 Z:0.0
	GeometryName					= TrebGeom
	GeometryActive					= No

	AdditionalGeometry				= BOX
	GeometryMajorRadius				= 20.0
	GeometryMinorRadius				= 20.0
	GeometryHeight					= 120.0
	GeometryOffset					= X:45.0 Y:0.0 Z:0.0
	GeometryName					= TowerGeom
	GeometryActive					= No
	
	
	GeometryContactPoint	= X: 37.0	Y:-16.0		Z:120	Swoop
	GeometryContactPoint	= X: 37.0	Y:  0.0		Z:0		Grab
	GeometryContactPoint	= X: 37.0	Y: 16.0		Z:120	Swoop

	
	Shadow							= SHADOW_VOLUME
	
End


;----------------------------------------------------------------------------------------------
Object GondorCastleWall
        
        SelectPortrait = BPCastleWall
	Draw = W3DScriptedModelDraw Draw_Wall
		OkToChangeModelColor = Yes

	    WallBoundsMesh = P1

		DefaultModelConditionState
			Model = GBCASTWALL
		End

		ModelConditionState = WORLD_BUILDER
  			Model = GBCASTWALLW
  		End

		ModelConditionState = BASE_BUILD
  			Model = GBCASTWALL_A
  		End
		AnimationState = BASE_BUILD
			StateName = STATE_None
			Animation
				AnimationName = GBCASTWALL_A.GBCASTWALL_A
				AnimationMode = ONCE
				AnimationSpeedFactorRange = 2.0 2.5 ; keep range wide to avoid lockstep anims
			End
		End    
		
		ModelConditionState = JUST_BUILT
  			Model = GBCASTWALL_A
  		End
		AnimationState = JUST_BUILT
			StateName = STATE_None
			Animation
				AnimationName = GBCASTWALL_A.GBCASTWALL_A
				AnimationMode = MANUAL
			End
			Flags = START_FRAME_FIRST
		End

		; Need to enforce this model for this state because we can
		; repair a numenor upgraded wall.
		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
  			Model = GBCASTWALL_UA
  		End
		AnimationState = ACTIVELY_BEING_CONSTRUCTED UPGRADE_NUMENOR_STONEWORK
			Animation
				AnimationName = GBCASTWALL_UA.GBCASTWALL_UA
				AnimationMode = MANUAL
			End
			StateName = STATE_None
			Flags = START_FRAME_FIRST
		End    

		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED
  			Model = GBCASTWALL_A
  		End
		AnimationState = ACTIVELY_BEING_CONSTRUCTED
			Animation
				AnimationName = GBCASTWALL_A.GBCASTWALL_A
				AnimationMode = MANUAL
			End
			StateName = STATE_None
			Flags = START_FRAME_FIRST
		End    
		
		; DAMAGED ----------------------------------------------------------------------------------------------------------------
		ModelConditionState  = DAMAGED UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTWALL_UD1
		End
		
		ModelConditionState  = DAMAGED 
			Model         = GBCASTWALL_D1  
		End

		AnimationState = DAMAGED
			StateName = STATE_None
;			EnteringStateFX = FX_MinWallATransitionDamaged
		End
 
		; REALLYDAMAGED ----------------------------------------------------------------------------------------------------------------
		TransitionState = TRANS_U_IntoReallyDamaged
			EnteringStateFX		= FX_BuildingReallyDamaged
			Animation = D2
				AnimationName		= GBCASTWALL_UD2.GBCASTWALL_UD2
				AnimationMode		= ONCE
				AnimationBlendTime	= 0
			End
		End
		ModelConditionState  = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTWALL_UD2
		End
		AnimationState = REALLYDAMAGED UPGRADE_NUMENOR_STONEWORK
			StateName = STATE_ReallyDamaged
	 		Flags = START_FRAME_LAST
			Animation				= ReallyDamagedanimation
				AnimationName		= GBCASTWALL_UD2.GBCASTWALL_UD2
				AnimationMode		= MANUAL
				AnimationBlendTime	= 0
   			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "STATE_None" or Prev == "STATE_Rubble"
				then
					; Only play the really damaged anim if we havn't come from another really damaged.
					CurDrawableSetTransitionAnimState("TRANS_U_IntoReallyDamaged")
				end
			EndScript
		End

		ModelConditionState  = REALLYDAMAGED
			Model         = GBCASTWALL_D2
		End
		AnimationState = REALLYDAMAGED
			StateName				= STATE_ReallyDamaged
			Animation				= ReallyDamagedanimation
				AnimationName		= GBCASTWALL_D2.GBCASTWALL_D2
				AnimationMode		= ONCE
   			End
		End

		; RUBBLE ----------------------------------------------------------------------------------------------------------------
		TransitionState = TRANS_U_IntoRubble
			Animation = D3
				AnimationName		= GBCASTWALL_UD3.GBCASTWALL_UD3
				AnimationMode		= ONCE
				AnimationBlendTime = 0
			End
		End
		ModelConditionState  = RUBBLE UPGRADE_NUMENOR_STONEWORK
			Model         = GBCASTWALL_UD3
      ParticleSysBone NONE BuildingChunkBitsTrail
      ParticleSysBone NONE ExplosiveMineFire02
    End
		AnimationState = RUBBLE UPGRADE_NUMENOR_STONEWORK
			StateName = STATE_Rubble
			Flags = START_FRAME_LAST
			Animation				= Death
				AnimationName		= GBCASTWALL_UD3.GBCASTWALL_UD3
				AnimationMode		= MANUAL
			AnimationBlendTime		= 0
			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "STATE_ReallyDamaged" or Prev == "STATE_None" or Prev == "TRANS_U_IntoReallyDamaged"
				then
					; Only play the rubble anim if we havn't come from another rubble.
					CurDrawableSetTransitionAnimState("TRANS_U_IntoRubble")
				end
			EndScript
			;EnteringStateFX	= FX_WallDie	;this plays only after all the wall debris sink into the ground
		End
		
		ModelConditionState  = RUBBLE
			Model         = GBCASTWALL_D3
      ParticleSysBone NONE BuildingChunkBitsTrail
      ParticleSysBone NONE ExplosiveMineFire02
    End
		AnimationState = RUBBLE
			Animation				=	Death
				AnimationName		=	GBCASTWALL_D3.GBCASTWALL_D3
				AnimationMode		=	ONCE
			End
			StateName = STATE_Rubble
			EnteringStateFX	= FX_WallDie
		End      
 
 		; UPGRADED ----------------------------------------------------------------------------------------------------------------
  		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
  			Model = GBCASTWALL_U
  		End

  		AnimationState = UPGRADE_NUMENOR_STONEWORK
			EnteringStateFX = GenericBuildingUpgrade
		End

		ModelConditionState  = POST_RUBBLE
			Model         = None
		End

		ModelConditionState  = POST_COLLAPSE
			Model         = None
		End
		
	End
	
  
	;----------------------- AUDIO -------------------------

	VoiceSelect				= Gui_PlotSelect

	SoundOnDamaged			= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
 		AnimationSound = Sound:WallDie	Animation:GBCASTWALL_UD3.GBCASTWALL_UD3	Frames:0
	End


	; ***DESIGN parameters ***
	DisplayName		= OBJECT:GondorCastleWall
	EditorSorting	= STRUCTURE
	Side			= Men
	BuildTime		= CASTLE_WALL_REBUILD_TIME
	BuildCost		= CASTLE_WALL_REBUILD_COST
  	ShroudClearingRange = 160

	ArmorSet
		Conditions	= None
		Armor		= GondorCastleWall
		DamageFX	= MinasWallADamageFX
	End

	; *** ENGINEERING Parameters ***  
	KindOf					= STRUCTURE IMMOBILE WALK_ON_TOP_OF_WALL CHUNK_VENDOR SELECTABLE NOT_AUTOACQUIRABLE ;;;should this get autoacquired, or not? NO! or attack move will fail to enter the gate!
	RadarPriority			= STRUCTURE
	VisionRange				= GONDOR_ARCHER_VISION_RANGE
	KeepSelectableWhenDead	= Yes
	CommandSet				= GenericSelfRepairCommandSet
	
	Body				= ActiveBody ModuleTag_02
		MaxHealth		= GONDOR_CASTLE_WALL_HEALTH
		
		GrabObject = EntThrownBuildingRock
		GrabFX = FX_WallGrab
		GrabDamage = 490
		GrabOffset = X:16 Y:0
	End

	Behavior                  = BuildingBehavior BuildingModuleTag
		NightWindowName         = WINDOW_N01
	;	FireWindowName          = WINDOW_F01
	;	GlowWindowName			= WINDOW_G01
	;	FireName				= FIRE01
	End
	
	Behavior = GettingBuiltBehavior ModuleTag_GettingBuilt
	    SelfBuildingLoop = BuildingConstructionLoop ; Only played if we DON'T spawn a worker
		SelfRepairFromDamageLoop  = NoSound         ; This doesn't cause an animation, so don't bother playing a sound
		SelfRepairFromRubbleLoop  = BuildingConstructionLoop
		SpawnTimer = -1.0 ; Negative means no 'autoheal'
		RebuildTimeSeconds = CASTLE_WALL_REBUILD_TIME
	End

    Behavior = SiegeDockingBehavior ModuleTag_SiegeDocking
    End
	
    Behavior = KeepObjectDie ModuleTag_IWantRubble
    End

    Behavior = CastleMemberBehavior ModuleTag_CMB
		CountsForEvaCastleBreached = Yes
    End 

  	Behavior = AttributeModifierAuraUpdate ModuleTag_WallBonus
		StartsActive	= Yes ;If no, requires upgrade to turn on.
		BonusName		= WallBonus
		RefreshDelay	= 2000
		ObjectFilter	= ALL -MACHINE
		;Range			= 120		; Range is overridden to affect people on us since we are a wall
		;TargetEnemy		= Yes	; Alliances are ignored to affect people on us since we are a wall
	End	

	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_NumenorStonework
		AttributeModifier		= NumenorStonework_Bonus
		CustomAnimAndDuration	= AnimState:UPGRADE_NUMENOR_STONEWORK AnimTime:0
	End

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag1
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= CastleWallDeath
	End	

 	Behavior = FireWeaponWhenDeadBehavior FireDeadTag2
		DeathTypes					= ALL
		StartsActive				= Yes
		ActiveDuringConstruction	= Yes
		DeathWeapon					= StandardWallDeath
	End	

	Geometry						= BOX
	GeometryMajorRadius				= 22.0
	GeometryMinorRadius				= 90.0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-3 Y:0 Z:0
	
	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius				= 26.0
	GeometryMinorRadius				= 0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y:-80 Z:0
	
	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius				= 26.0
	GeometryMinorRadius				= 0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y:80 Z:0

	AdditionalGeometry				= BOX
	GeometryMajorRadius				= 18.0
	GeometryMinorRadius				= 1.0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y: 98 Z:0
	GeometryName					= Bookend
	
	AdditionalGeometry				= BOX
	GeometryMajorRadius				= 18.0
	GeometryMinorRadius				= 1.0
	GeometryHeight					= 53.0
	GeometryOffset					= X:-10 Y:-98 Z:0
	GeometryName					= Bookend
	
	GeometryContactPoint			= X:-29.397		Y:0.326		Z:108.421		Swoop
	GeometryContactPoint			= X: 40 Y:-70 Z:0 Grab
	GeometryContactPoint			= X:-40 Y:-60 Z:0 Grab
	GeometryContactPoint			= X: 23 Y:-40 Z:0 Grab
	GeometryContactPoint			= X:-18 Y:-40 Z:0 Grab
	GeometryContactPoint			= X: 23 Y: 40 Z:0 Grab
	GeometryContactPoint			= X:-40 Y: 40 Z:0 Grab
	GeometryContactPoint			= X: 40 Y: 60 Z:0 Grab
	GeometryContactPoint			= X:-40 Y: 70 Z:0 Grab
	
	
	GeometryIsSmall					= No
	GeometryRotationAnchorOffset	= X:375.0 Y:0.0
	Shadow							= SHADOW_VOLUME
End

