;//------------------------------------------------------------------------------
;// This is the magic thing in the .bse file that tells how to center the base layout compared to the game position of the fortress
Object DwarvenFortressCenterGeneric	

	SelectPortrait = BPDFortress

	Draw = W3DScriptedModelDraw ModuleTag_01

    	DefaultModelConditionState
      		Model = None
    	End
    	
		ModelConditionState = WORLD_BUILDER
			Model = NBasePin
		End
	End
	
	Side			= Dwarves
	EditorSorting	= STRUCTURE
	KindOf			= IMMOBILE BASE_FOUNDATION CASTLE_CENTER
  
	Behavior = CastleBehavior ModuleTag_castle
		FilterValidOwnedEntries = ANY +STRUCTURE +WALK_ON_TOP_OF_WALL +BASE_FOUNDATION +TACTICAL_MARKER		;Anything that does not fit this filter will be given to the neutral player, so the template can have rocks and props.
	End  
End

;//------------------------------------------------------------------------------
;// These are the four corner buildplots.  Difference is just the BuildVariation flag they give the Expansion.
Object DwarvenFortressExpansionPadCorner	
	
	SelectPortrait = BPDFortress_BuildPlot
	
	;// *** ART Parameters ***

	Draw = W3DFloorDraw DrawFloorBase  
		ModelName = DBFoundation
	End
	
	Draw = W3DScriptedModelDraw ModuleTag_DrawMain
		DefaultModelConditionState
			Model = WBFoundationP
		End
		;//Remove the buildplot when it's been constructed on
		ModelConditionState = CONSTRUCTION_COMPLETE
			Model = None
		End		
	End

	;//PlacementViewAngle  = 0

	;// ***DESIGN parameters ***
	DisplayName         = OBJECT:DwarvenBuildingFoundation
	Description 	    = OBJECT:IsengardFortressDescription
	Side                = Dwarves
	EditorSorting       = STRUCTURE
	ThreatLevel 		= WALL_THREAT_LEVEL	; 1.0

	BuildCost           = 1
	BuildTime           = 5.0          ;// in seconds
	VisionRange         = 0.0          ;// Shroud clearing distance
	ShroudClearingRange = 0

	CommandSet = DwarvenFortressExpansionPadCornerCommandSet

	;// *** AUDIO Parameters ***

	VoiceSelect = Gui_PlotSelect2	;MenFortressSelect

	;// *** ENGINEERING Parameters ***	
	KindOf              = STRUCTURE SELECTABLE IMMOBILE BASE_FOUNDATION UNATTACKABLE MP_COUNT_FOR_VICTORY NO_COLLIDE DO_NOT_CLASSIFY EXPANSION_PAD

	Behavior            = FoundationAIUpdate ModuleTag_foundationAI
		BuildVariation = 1 ;// Will give BUILD_VARIATION_TWO to anything built on it
	End

	Behavior = CastleMemberBehavior ModuleTag_CMB
	End 

	Body                = ImmortalBody ModuleTag_05
		MaxHealth         = 15000.0
	End

	Geometry              = BOX
	GeometryMajorRadius   = 5.0
	GeometryMinorRadius   = 5.0
	GeometryHeight        = 0.8
	GeometryIsSmall       = No
	Shadow                = NONE
	BuildCompletion			= PLACED_BY_PLAYER
End

// And these are the 3 on the sides.

ChildObject DwarvenFortressExpansionPadSide DwarvenFortressExpansionPadCorner ; And these are the 2 on the sides.

	CommandSet = DwarvenFortressExpansionPadSideCommandSet

	Behavior            = FoundationAIUpdate ModuleTag_foundationAI
		BuildVariation = 1 // Will give BUILD_VARIATION_ONE to anything built on it
	End
End

//------------------------------------------------------------------------------
//For the fortress hub... this is for the corners of the fortress
Object  DwarvenWallHubSmallExpansion
  
	// *** ART Parameters ***
  
  	SelectPortrait = BPDFortress_WallHub
  
	Draw = W3DScriptedModelDraw ModuleTag_Draw
		OkToChangeModelColor  = Yes
		UseStandardModelNames = Yes
		
		DefaultModelConditionState
			Model = DBGFWHUB
		End

		//---Buildup---
		ModelConditionState = UPGRADE_NUMENOR_STONEWORK ACTIVELY_BEING_CONSTRUCTED 
			Model		= DBGFWHUB_A
			Texture		= DBFortress1.tga DBFortress_U.tga
		End

		ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED
			Model	= DBGFWHub_A		
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End 
		
		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED
			Model			= DBGFWHub_A
		End

		AnimationState = ACTIVELY_BEING_CONSTRUCTED
			Animation					= UpAndStill
				AnimationName			= DBGFWHub_A.DBGFWHub_A
				AnimationMode			= MANUAL
			End
			ParticleSysBone = NONE BuildingContructDust
			BeginScript
				CurDrawablePlaySound("GondorBarracksBeginConstruction")
			EndScript
		End
		
		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED 
			Model = DBGFWHub_A
		End

		AnimationState        = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
			Animation           = DBGFWHub_A
				AnimationName     = DBGFWHub_A.DBGFWHub_A
				AnimationMode     = ONCE
			End
;			BeginScript
;				CurDrawablePlaySound("GondorBarracksBeginConstruction")
;			EndScript
		End
		
		//--Damage---
		ModelConditionState  = DAMAGED
			Model         = DBGFWHub_D1			
		End
		AnimationState = DAMAGED
			EnteringStateFX	= FX_FortressDamaged ;FX_BuildingDamaged ;FX_HubDamaged
		End	    
		
		ModelConditionState  = REALLYDAMAGED
			Model       = DBGFWHub_D2			
		End
	    
	    AnimationState = REALLYDAMAGED
      		Animation				= RubbleAnimation
				AnimationName		= DBGFWHub_D2.DBGFWHub_D2
				AnimationMode		= ONCE
  			End
		    EnteringStateFX	= FX_FortressReallyDamaged ; FX_BuildingReallyDamaged ;FX_HubDamaged
		End
 
		ModelConditionState  = RUBBLE
			Model         = DBGFWHub_D3
		End
		
		AnimationState = RUBBLE
      		Animation				= RubbleAnimation
				AnimationName		= DBGFWHub_D3.DBGFWHub_D3
				AnimationMode		= ONCE
  			End
  			EnteringStateFX	= FX_FortressCollapse ;FX_StructureMediumCollapse
		End

		//---Stonework---
		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
			Model		= DBGFWHUB
			Texture		= DBFortress1.tga DBFortress_U.tga
		End

		//---Snow---
		ModelConditionState = SNOW
			Model	= DBGFWHUB		
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End 		
	End

	Draw = W3DFloorDraw ModuleTag_DrawFloor    
		StaticModelLODMode = yes			// Will append M or L to the skin name depending on GameLOD
 		ModelName = GBWallRmprtNBib
	End

	;// ***DESIGN parameters ***
	DisplayName         	= OBJECT:DwarvenCastleWallHubExpansion
	Description		= OBJECT:DwarvenFortressDescription

	Side               	= Dwarves
	EditorSorting       	= STRUCTURE
	ThreatLevel 		= WALL_THREAT_LEVEL		; 1.0
	 
	BuildCost           	= DWARVEN_WALLHUB_SMALL_BUILDCOST
	BuildTime           	= DWARVEN_WALLHUB_SMALL_BUILDTIME          // in seconds
	VisionRange         	= DWARVEN_WALLHUB_SMALL_VISION_RANGE       // Shroud clearing distance
	ShroudClearingRange 	= DWARVEN_WALLHUB_SMALL_SHROUD_CLEAR       

	CommandSet = DwarvenCastleWallHubSmallCommandSet

	ArmorSet
		Conditions        = None
		Armor             = DwarvenWallArmor
	End
	
	;// ***AUDIO parameters ***

	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	VoiceSelect					= NeutralWallHubSelect

	SoundOnDamaged				= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:StatueHeroicBuildStoneDebris2 Animation:DBGFWHUB_A.DBGFWHUB_A Frames:120
		AnimationSound = Sound:StatueHeroicBuildStoneDebris1 Animation:DBGFWHUB_A.DBGFWHUB_A Frames:135
	End

	UnitSpecificSounds
		UnderConstruction			= BuildingConstructionLoop  ;// Built first time
		;//UnderRepairFromDamage	= NoSound					;// Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble		= BuildingConstructionLoop	;// Repaired from completely destroyed (not used???)
	End

	;Behavior            			= GettingBuiltBehavior ModuleTag_04
	;	RebuildTimeSeconds			= 30
	;	SelfBuildingLoop			= WallConstructionLoop		;Only played if we DON'T spawn a worker
	;	SelfRepairFromDamageLoop	= NoSound					;This doesn't cause an animation, so don't bother playing a sound
	;	SelfRepairFromRubbleLoop	= WallConstructionLoop
	;End

	CampnessValue = CAMPNESS_FORTRESS_EXPANSION ; Even though it's a wall, it's still a fortress expansion

	// ***ENGINEERING parameters

	KindOf  = PRELOAD STRUCTURE SELECTABLE IMMOBILE SCORE NEED_BASE_FOUNDATION FS_BASE_DEFENSE MADE_OF_STONE WALL_HUB ;WALL_UPGRADE	

	Behavior            = GettingBuiltBehavior ModuleTag_04
		WorkerName					= DwarvenWorkerNoSelect
		SpawnTimer	= DEFAULT_STRUCTURE_HEALDELAY
	End

	Body                = StructureBody ModuleTag_05
		MaxHealth         = 1500.0
	End

	Behavior = CastleMemberBehavior ModuleTag_CMB
    End 

	Behavior = WallHubBehavior ModuleTag_Build_A_Span			
		Options							= OPTION_ONE
		
		StaggeredBuildFactor = STANDARD_WALL_STAGGERED_BUILD_FACTOR
		
		MaxBuildoutDistance = MEN_FORTRESS_WALL_EFFECTIVE_RADIUS
	
		//This defines the pattern built on flat terrain
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallSegmentSmall
		SegmentTemplateName				= DwarvenWallHubSmall

		BuilderRadius = 20 // makes the first wall segment hug the (SKINNY) hub
		
		HubCapTemplateName				= DwarvenWallHubSmall
		DefaultSegmentTemplateName		= DwarvenWallSegmentSmall
		
		CliffCapTemplateName			= DwarvenWallCliffCap		
		//ShoreCapTemplateName			= [NAME]		
		//BorderCapTemplateName			= [NAME]		
		//ElevatedSegmentTemplateName	= [NAME]
		
	End

	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_DwarvenFortressDwarvenStonework
		AttributeModifier		= DwarvenStoneworkExpansion_Bonus
	End
	Behavior = ModelConditionUpgrade ModuleTag_ShowTheStones
		TriggeredBy			= Upgrade_DwarvenFortressDwarvenStonework		
		AddConditionFlags	= UPGRADE_NUMENOR_STONEWORK
		Permanent			= Yes
	End
		  
	Behavior = StructureCollapseUpdate ModuleTag_Collapse
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_StructureMediumCollapse
		FXList                  = ALMOST_FINAL  FX_StructureAlmostCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight			= 120
	End
		
	Behavior = TerrainResourceBehavior ModuleTag_NewMoneyDeadSpot
		Radius			= 100		;// How far we try to claim ground
		MaxIncome		= 0			;// If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval	= 999999	;// How often (in msec) we give that much money
		HighPriority	= Yes		;// A high priority claim gets to pretend it was there first.
		Visible = No 		;// Don't show decal when a resource building is selected.
	End

	GeometryIsSmall		= No

	Geometry			= CYLINDER
	GeometryMajorRadius	= 25.0	
	GeometryHeight		= 60.0	
	
	AdditionalGeometry	= BOX
	GeometryMajorRadius	= 20.0
	GeometryMinorRadius	= 10.0
	GeometryHeight		= 50.0	
	GeometryOffset		= X:-20 Y:0 Z:0

;	GeometryContactPoint = X:-21		Y:22		Z:0			Repair
	GeometryContactPoint = X:35		Y:0		Z:0			Repair
	GeometryContactPoint 	= X:22.954		Y:15.951	Z:0
	GeometryContactPoint 	= X:5.435		Y:-23.279	Z:0
	GeometryContactPoint	= X:-0.459		Y:-0.275	Z:116.828	Swoop
	
	Shadow					= SHADOW_VOLUME
	BuildCompletion			= PLACED_BY_PLAYER
End

//------------------------------------------------------------------------------
// This is the center part of the full Fortress.  This plus the buildplots make up the full fortress
Object DwarvenFortressCitadel			
	
	// *** ART Parameters ***
	
	SelectPortrait         = BPDFortress
	ButtonImage            = BDFortress

	//--------------------------------

	//--------------------------------
	Draw = W3DScriptedModelDraw ModuleTag_MainDraw		
		ExtraPublicBone = ARROW_01
		ExtraPublicBone = ARROW_02
		ExtraPublicBone = ARROW_03
		ExtraPublicBone = ARROW_04
		ExtraPublicBone = ARROW_05
		ExtraPublicBone = ARROW_06
		ExtraPublicBone = ARROW_07
		ExtraPublicBone = ARROW_08
		ExtraPublicBone = ARROW_09
		ExtraPublicBone = ARROW_10
		ExtraPublicBone = ARROW_11
		ExtraPublicBone = ARROW_12
		ExtraPublicBone = ARROW_13
		ExtraPublicBone = ARROW_14
		ExtraPublicBone = ARROW_15
		ExtraPublicBone = ARROW_16
		ExtraPublicBone = ARROW_17
		ExtraPublicBone = ARROW_18
		ExtraPublicBone = ARROW_19
		ExtraPublicBone = ARROW_20
		ExtraPublicBone = ARROW_21
		ExtraPublicBone = ARROW_22
		ExtraPublicBone = ARROW_23
		ExtraPublicBone = ARROW_24

		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model				= DBFortress
			WeaponLaunchBone	= PRIMARY		ARROW_
			WeaponLaunchBone	= SECONDARY		BARRELOUT1	//For Oil casks
			WeaponLaunchBone	= TERTIARY		BARRELOUT2
			WeaponLaunchBone	= QUATERNARY	BARRELOUT3
			WeaponLaunchBone	= QUINARY		BARRELOUT4
		End

		;//	Animation state for build placement cursor
		AnimationState = BUILD_PLACEMENT_CURSOR
			BeginScript
   				CurDrawableHideSubObject("DBFBANNER")
   				CurDrawableHideSubObject("DBFSKEGS")
			EndScript
		End
		
		;//	Animation state for phantom structure
		AnimationState = PHANTOM_STRUCTURE
			BeginScript
   				CurDrawableHideSubObject("DBFBANNER")
   				CurDrawableHideSubObject("DBFSKEGS")
			EndScript
		End
		
		//--Damage States---
		ModelConditionState  = DAMAGED
			Model		= DBFortress
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End
		
		AnimationState = DAMAGED
			EnteringStateFX	= FX_FortressDamaged			
		End

		ModelConditionState  = REALLYDAMAGED
			Model			= DBFortress_D2			
		End

		AnimationState	= REALLYDAMAGED
			Animation	= Fortress_ReallyDamaged
				AnimationName		= DBFortress_D2SK.DBFortress_D2AN
				AnimationMode		= ONCE				
			End			
			EnteringStateFX	= FX_FortressReallyDamaged
		End
		
		ModelConditionState  = RUBBLE
			Model			= DBFortress_D3						
		End
    
		AnimationState	= RUBBLE
			Animation	= Fortress_ReallyDamaged
				AnimationName		= DBFortress_D3SK.DBFortress_D3AN
				AnimationMode		= ONCE				
			End	
			EnteringStateFX	= FX_FortressCollapse		
		End

		//---Stonework---
		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
			Model		= DBFortress
			Texture		= DBFortress1.tga DBFortress_U.tga
		End

		//---Snow---
		ModelConditionState = SNOW
			Model	= DBFortress		
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End 		
	End

	Draw = W3DScriptedModelDraw ModuleTag_Draw_HCBanner
		OkToChangeModelColor  = Yes
		DefaultModelConditionState
			Model = DBHCFortress
		End
		MultiPlayerOnly = Yes 
	End
	
	;//-------------------------------
	;//Flaming Munitions
	Draw = W3DScriptedModelDraw ModuleTag_MunitionsDraw
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Build up
		ModelConditionState = FORTRESS_IMPROVEMENT_1 USER_2 DAMAGED
			Model           = DBFFlam_A
			Texture			= DBFortress1.tga DBFortress1_D.tga
		End
		
		ModelConditionState = FORTRESS_IMPROVEMENT_1 USER_2 REALLYDAMAGED
			Model           = DBFFlam_A			
			Texture			= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState = FORTRESS_IMPROVEMENT_1 USER_2
			Model           = DBFFlam_A			
		End
		
		AnimationState = FORTRESS_IMPROVEMENT_1 USER_2
			Animation					= RiseUp
				AnimationName			= DBFFlam_ASKL.DBFFlam_ABLD
				AnimationMode			= ONCE
			End
			ParticleSysBone     = SP001 DwfFortFlameDust
			Flags = START_FRAME_FIRST
		End		

		//--Damage States---
		ModelConditionState  = FORTRESS_IMPROVEMENT_1 DAMAGED
			Model		= DBFFlam
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState  = FORTRESS_IMPROVEMENT_1 REALLYDAMAGED
			Model			= DBFFlam_D2            
		End

		AnimationState	= FORTRESS_IMPROVEMENT_1 REALLYDAMAGED
			Animation	= DBFFlam_ReallyDamaged
				AnimationName		= DBFFlam_D2SK.DBFFlam_D2AN
				AnimationMode		= ONCE				
			End						
		End

		ModelConditionState  = FORTRESS_IMPROVEMENT_1 RUBBLE
			Model			= DBFFlam_D3			
		End
    
		AnimationState	= FORTRESS_IMPROVEMENT_1 RUBBLE
			Animation	= DBFFlam_ReallyDamaged
				AnimationName		= DBFFlam_D3SK.DBFFlam_D3AN
				AnimationMode		= ONCE				
			End			
		End		

		//Normal
		ModelConditionState = FORTRESS_IMPROVEMENT_1
			Model				= DBFFlam
			ParticleSysBone     = glowBone01 SmokeDwfFort FollowBone:Yes
			ParticleSysBone     = glowBone02 SmokeDwfFort FollowBone:Yes
			ParticleSysBone     = glowBone01 SmokeDwfFire FollowBone:Yes
			ParticleSysBone     = glowBone02 SmokeDwfFire FollowBone:Yes
		End
	End

	;//--------------------------------
	;//Oil Casks
	Draw = W3DScriptedModelDraw ModuleTag_MainOilStruct
		
		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End
		
		//---Build Up---
		ModelConditionState = FORTRESS_IMPROVEMENT_2 USER_3 DAMAGED
			Model           = DBFRBarrel_A
			Texture			= DBFortress1.tga DBFortress1_D.tga
		End
		
		ModelConditionState = FORTRESS_IMPROVEMENT_2 USER_3 REALLYDAMAGED
			Model           = DBFRBarrel_A
			Texture			= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState = FORTRESS_IMPROVEMENT_2 USER_3
			Model           = DBFRBarrel_A			
		End
		
		AnimationState = FORTRESS_IMPROVEMENT_2 USER_3
			Animation					= RiseUp
				AnimationName			= DBFRBarrel_ASK.DBFRBarrel_ABL
				AnimationMode			= ONCE
			End			
		End

		//--Damage States---
		ModelConditionState  = FORTRESS_IMPROVEMENT_2 DAMAGED
			Model		= DBFRBarrel
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState  = FORTRESS_IMPROVEMENT_2 REALLYDAMAGED
			Model			= DBFRBarrel_D2            
		End

		AnimationState	= FORTRESS_IMPROVEMENT_2 REALLYDAMAGED
			Animation	= DBFRBarrel_ReallyDamaged
				AnimationName		= DBFRBarrel_D2S.DBFRBarrel_D2A
				AnimationMode		= ONCE				
			End						
		End

		ModelConditionState  = FORTRESS_IMPROVEMENT_2 RUBBLE
			Model			= DBFRBarrel_D3			
		End
    
		AnimationState	= FORTRESS_IMPROVEMENT_2 RUBBLE
			Animation	= DBFRBarrel_ReallyDamaged
				AnimationName		= DBFRBarrel_D3S.DBFRBarrel_D3A
				AnimationMode		= ONCE				
			End			
		End		

		//Normal
		ModelConditionState	= FORTRESS_IMPROVEMENT_2
			Model		= DBFRBarrel
		End
	End

	Draw = W3DScriptedModelDraw ModuleTag_OilDwarfDraw1
		AttachToBoneInAnotherModule = BARRELIN1

		DefaultModelConditionState
			Model           = None
		End
		
		ModelConditionState = FORTRESS_IMPROVEMENT_2
			Model           = DUBarrl_SKN
		End	
		
		AnimationState			= SPECIAL_WEAPON_ONE UNPACKING FORTRESS_IMPROVEMENT_2
			Animation			= Pouring
				AnimationName	= DUBarrl_SKL.DUBarrl_BRLA
				AnimationMode   = ONCE
			End
			EnteringStateFX		= FX_OilCaskDropSound
		End

		AnimationState = FORTRESS_IMPROVEMENT_2
			Animation					= UpAndStill
				AnimationName			= DUBarrl_SKL.DUBarrl_IDLA
				AnimationMode			= LOOP
			End			
		End
	End

	Draw = W3DScriptedModelDraw ModuleTag_OilDwarfDraw2
		AttachToBoneInAnotherModule = BARRELIN2

		DefaultModelConditionState
			Model           = None
		End
		
		ModelConditionState = FORTRESS_IMPROVEMENT_2
			Model           = DUBarrl_SKN
		End	
		
		AnimationState			= SPECIAL_WEAPON_ONE UNPACKING FORTRESS_IMPROVEMENT_2
			Animation			= Pouring
				AnimationName	= DUBarrl_SKL.DUBarrl_BRLA
				AnimationMode   = ONCE
			End
		End

		AnimationState = FORTRESS_IMPROVEMENT_2
			Animation					= UpAndStill
				AnimationName			= DUBarrl_SKL.DUBarrl_IDLA
				AnimationMode			= LOOP
			End			
		End
	End

	Draw = W3DScriptedModelDraw ModuleTag_OilDwarfDraw3
		AttachToBoneInAnotherModule = BARRELIN3

		DefaultModelConditionState
			Model           = None
		End
		
		ModelConditionState = FORTRESS_IMPROVEMENT_2
			Model           = DUBarrl_SKN
		End	
		
		AnimationState			= SPECIAL_WEAPON_ONE UNPACKING FORTRESS_IMPROVEMENT_2
			Animation			= Pouring
				AnimationName	= DUBarrl_SKL.DUBarrl_BRLA
				AnimationMode   = ONCE
			End
		End

		AnimationState = FORTRESS_IMPROVEMENT_2
			Animation					= UpAndStill
				AnimationName			= DUBarrl_SKL.DUBarrl_IDLA
				AnimationMode			= LOOP
			End			
		End
	End

	Draw = W3DScriptedModelDraw ModuleTag_OilDwarfDraw4
		AttachToBoneInAnotherModule = BARRELIN4

		DefaultModelConditionState
			Model           = None
		End
		
		ModelConditionState = FORTRESS_IMPROVEMENT_2
			Model           = DUBarrl_SKN
		End	
		
		AnimationState			= SPECIAL_WEAPON_ONE UNPACKING FORTRESS_IMPROVEMENT_2
			Animation			= Pouring
				AnimationName	= DUBarrl_SKL.DUBarrl_BRLA
				AnimationMode   = ONCE
			End
		End

		AnimationState = FORTRESS_IMPROVEMENT_2
			Animation					= UpAndStill
				AnimationName			= DUBarrl_SKL.DUBarrl_IDLA
				AnimationMode			= LOOP
			End			
		End
	End

	;//--------------------------------
	;//Mighty Catapult Tower
	Draw = W3DScriptedModelDraw ModuleTag_MightyCatapultTowerDraw
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Build Up
		ModelConditionState = UPGRADE_FORTRESS_MONUMENT USER_1 DAMAGED
			Model		= DBFGCap_A
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState = UPGRADE_FORTRESS_MONUMENT USER_1 REALLYDAMAGED
			Model		= DBFGCap_A
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState = UPGRADE_NUMENOR_STONEWORK UPGRADE_FORTRESS_MONUMENT USER_1
			Model		= DBFGCap_A			
			Texture	= DBFortress1.tga DBFortress_U.tga
		End

		ModelConditionState = UPGRADE_FORTRESS_MONUMENT USER_1
			Model		= DBFGCap_A			
		End
		
		AnimationState = UPGRADE_FORTRESS_MONUMENT USER_1
			Animation						= RiseUp
				AnimationName				= DBFGCap_ASKL.DBFGCap_ABLD
				AnimationMode				= ONCE
				AnimationSpeedFactorRange	= 4.0 4.0
			End
		End

		//--Damage States---
		ModelConditionState  = UPGRADE_FORTRESS_MONUMENT DAMAGED
			Model		= DBFGCap
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState  = UPGRADE_FORTRESS_MONUMENT REALLYDAMAGED
			Model			= DBFGCap_D2			
		End

		AnimationState	= UPGRADE_FORTRESS_MONUMENT REALLYDAMAGED
			Animation	= DBFGCap_ReallyDamaged
				AnimationName		= DBFGCap_D2SKL.DBFGCap_D2AN
				AnimationMode		= ONCE				
			End						
		End

		ModelConditionState  = UPGRADE_FORTRESS_MONUMENT RUBBLE
			Model			= DBFGCap_D3			
		End
    
		AnimationState	= UPGRADE_FORTRESS_MONUMENT RUBBLE
			Animation	= DBFGCap_ReallyDamaged
				AnimationName		= DBFGCap_D3SKL.DBFGCap_D3AN
				AnimationMode		= ONCE				
			End			
		End		
		
		//Stonework
		ModelConditionState = UPGRADE_NUMENOR_STONEWORK UPGRADE_FORTRESS_MONUMENT
			Model	= DBFGCap
			Texture	= DBFortress1.tga DBFortress_U.tga
		End

		//Snow
		ModelConditionState = SNOW UPGRADE_FORTRESS_MONUMENT
			Model	= DBFGCap		
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End   
		
		//Normal
		ModelConditionState = UPGRADE_FORTRESS_MONUMENT
			Model           = DBFGCap
		End
	End

	;//--------------------------------
	;//Fortress Door
	Draw = W3DScriptedModelDraw ModuleTag_DrawDoor
	     
		DefaultModelConditionState
			Model = DBFDoor_DRC
		End

		//---Damage States---		
		ModelConditionState   = DAMAGED DOOR_1_WAITING_OPEN
			Model		= DBFDoor_DRO
			Texture		= DBFortress1.tga DBFortress1_D.tga			
		End  

		ModelConditionState   = REALLYDAMAGED DOOR_1_WAITING_OPEN
			Model		= DBFDoor_DRO
			Texture		= DBFortress1.tga DBFortress1_D.tga			
		End  

		ModelConditionState = DAMAGED
			Model		= DBFDoor_DRC
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState = REALLYDAMAGED
			Model		= DBFDoor_DRC
			Texture		= DBFortress1.tga DBFortress1_D.tga
		End

		ModelConditionState = RUBBLE
			Model		= DBFDoor_D3
		End

		AnimationState	= RUBBLE
			Animation	= Door_ReallyDamaged
				AnimationName		= DBFDoor_D3.DBFDoor_D3
				AnimationMode		= ONCE
				AnimationBlendTime	= 50
			End			
		End
	     
		//--normal states
		ModelConditionState   = DOOR_1_OPENING
			Model               = DBFDoor_DROA
		End
	    
		AnimationState			=	DOOR_1_OPENING
			Animation           =	DBFDoor_DRO
				AnimationName   =	DBFDoor_DROA.DBFDoor_DROA
				AnimationMode   =	ONCE	
				AnimationBlendTime = 0
			End
		;//	Flags				=	START_FRAME_FIRST
		End 
	   
	   
		ModelConditionState   = DOOR_1_CLOSING
			Model               = DBFDoor_DRCA
				ParticleSysBone	  = NONE trollCageDust
			End;  
		   
   			AnimationState			=	DOOR_1_CLOSING
				Animation           =	DBFDoor_DRCA
					AnimationName   =	DBFDoor_DRCA.DBFDoor_DRCA
					AnimationMode   =	ONCE
					AnimationBlendTime = 0
				End
			;	Flags				=	START_FRAME_FIRST
		End   
	   
	   
		ModelConditionState   = DOOR_1_WAITING_OPEN
		Model               = DBFDoor_DRO
			;ParticleSysBone	  = NONE BuildingDoughnutCloud
		End  
	    
		AnimationState			=	DOOR_1_WAITING_OPEN
		End   

		ModelConditionState  = POST_RUBBLE
			Model         = None
		End

		ModelConditionState  = POST_COLLAPSE
			Model         = None
		End
	  
	End

	//----------the Bib
    Draw = W3DFloorDraw ModuleTag_DrawFloor    
		ModelName			= DBFortress_Bib
  		WeatherTexture		= SNOWY GBWall_Bib_Snow.tga 
	End

	// ***DESIGN parameters ***
	DisplayName         	= OBJECT:DwarvenFortress
	Description 	    	= OBJECT:IsengardFortressDescription
	Side                	= Dwarves
	EditorSorting       	= STRUCTURE
	ThreatLevel		= FORTRESS_THREAT_LEVEL			; 1.0
	CommandPointBonus	= GENERIC_FORTRESS_COMMAND_POINT_BONUS

	BuildCost           	= 0
	BuildTime           	= DWARVEN_FORTRESS_BUILDTIME           	; in seconds
	VisionRange         	= DWARVEN_FORTRESS_VISION_RANGE          
	ShroudClearingRange 	= DWARVEN_FORTRESS_SHROUD_CLEAR	

	CommandSet			= DwarvenFortressCommandSet

	WeaponSet
		Conditions		= None
		Weapon			= PRIMARY FortressStructureAxeWeapon
		AutoChooseSources	= PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI
	End

	ArmorSet
		Conditions        = None
		Armor             = FortressArmor
	;	DamageFX          = StructureDamageFXNoShake
	End

	;// *** AUDIO Parameters ***

	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	EvaEventDieOwner 		= EvaFortressDie

	VoiceSelect			= DwarvenFortressSelect

	SoundOnDamaged			= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction

	UnitSpecificSounds
		UnderConstruction	= BuildingBigConstructionLoop		;// Built first time
		;//UnderRepairFromDamage	= NoSound			;// Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble		= BuildingBigConstructionLoop	;// Repaired from completely destroyed (not used???)
	End

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:StatueHeroicBuildStoneDebris2 Animation:DBFGCAP_A.DBFGCAP_A Frames:116
		AnimationSound = Sound:StatueHeroicBuildStoneDebris1 Animation:DBFGCAP_A.DBFGCAP_A Frames:130
	End

	CampnessValue = CAMPNESS_FORTRESS

	;// *** ENGINEERING Parameters ***

	RadarPriority       = STRUCTURE
 	KindOf				= PRELOAD COMMANDCENTER VITAL_FOR_BASE_SURVIVAL STRUCTURE IMMOBILE CASTLE_KEEP MP_COUNT_FOR_VICTORY SELECTABLE FS_FACTORY AUTO_RALLYPOINT MADE_OF_WOOD SCORE DOZER_FACTORY

	Behavior            = GettingBuiltBehavior ModuleTag_GettingBuiltBehavior
		WorkerName	= DwarvenWorkerNoSelect
		SpawnTimer	= DEFAULT_STRUCTURE_HEALDELAY
	End

     Behavior = CastleMemberBehavior ModuleTag_CMB
		BeingBuiltSound = BuildingBigConstructionLoop
     End 
     


	;//-----------------------------------------------
	;//Used for hero revival and initial construction     
	Behavior = ProductionUpdate ProductionUpdateModuleTag
		ProductionModifier		;// An object-local discount.  
			RequiredUpgrade	= Upgrade_DwarvenFortressBanners 
			CostMultiplier	= 0.80
			ModifierFilter	= NONE +DwarvenPorter
		End
		ProductionModifier		
			RequiredUpgrade = Upgrade_DwarvenFortressBanners 
			CostMultiplier	= 0.90
			TimeMultiplier	= 0.90
			HeroPurchase	= Yes	;// Instead of an object filter, needs to be explicitly hero-revival-system compatible
		End

  		NumDoorAnimations            = 1
		DoorOpeningTime              = 3000  ;//in mSeconds how long you want doors to be in open state
		DoorWaitOpenTime             = 3000  ;//in mSeconds time the door stays open, so units can exit
		DoorCloseTime                = 3000  ;//in mSeconds how long you want doors to be in open state		
	End
	
	Behavior = QueueProductionExitUpdate ModuleTag_QueuePEU
		UnitCreatePoint		= X:57.0 Y:0.0 Z:0.0
		NaturalRallyPoint	= X:109.0 Y:0.0 Z:0.0	;//NaturalRallyPointX must always match GeometryMajorRadius!
		ExitDelay			= 400					;// Mainly for the multiple produced Red Guard.  Make them come out one at a time.
	End  
	;//-----------------------------------------------

	Body                = StructureBody ModuleTag_05
		MaxHealth					= DWARVEN_FORTRESS_HEALTH
		MaxHealthDamaged  		    = DWARVEN_FORTRESS_HEALTH_DAMAGED
		MaxHealthReallyDamaged 	  	= DWARVEN_FORTRESS_HEALTH_REALLY_DAMAGED
	End
 
	Behavior                  = StructureCollapseUpdate ModuleTag_08
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_StructureMediumCollapseNoSound
		FXList                  = ALMOST_FINAL  FX_StructureAlmostCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight			= 155
	End

	Behavior = CitadelSlaughterHordeContain ModuleTag_SlaughterMe
		PassengerFilter					= GENERIC_FACTION_SLAUGHTERABLE
		ObjectStatusOfContained			= UNSELECTABLE ENCLOSED
		CashBackPercent					= 200%		
		ContainMax						= 99	// give it a huge capacity, just in case player sends his whole army in at once
		AllowEnemiesInside				= No
		AllowAlliesInside				= No
 		AllowNeutralInside				= No
 		AllowOwnPlayerInsideOverride	= Yes
		EnterSound						= GUI_RingReturned
		EntryOffset						= X:125.0 Y:0.0 Z:0.0
		EntryPosition					= X:30.0 Y:0.0 Z:0.0
		
		ExitOffset						= X:125.0 Y:0.0 Z:0.0
		StatusForRingEntry				= HOLDING_THE_RING
		UpgradeForRingEntry				= Upgrade_RingHero Upgrade_FortressRingHero
		ObjectToDestroyForRingEntry		= NONE +TheDroppedRing
		FXForRingEntry					= FX_OneRingFlare
	End
	
  
	// Hide all the Improvements by default
	Behavior = SubObjectsUpgrade ModuleTag_HideAll
		TriggeredBy		= Upgrade_StructureLevel1
		HideSubObjects	= DBFSKEGS DBFRBARREL
	End

	// Oil Casks special power, bought as improvement
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_OilEnabler
		SpecialPowerTemplate = SpecialAbilityDwarvenFortressOilCasks
		TriggeredBy = Upgrade_DwarvenFortressOilCasks
	End
	Behavior = SpecialPowerModule ModuleTag_OilStarter       
		SpecialPowerTemplate      = SpecialAbilityDwarvenFortressOilCasks
		UpdateModuleStartsAttack  = Yes
		StartsPaused		  	  = Yes
		;InitiateSound				= OilCaskFlyBy	;this didn't work
	End
	Behavior = WeaponFireSpecialAbilityUpdate ModuleTag_OilWeaponFireUpdate   
		SpecialPowerTemplate    = SpecialAbilityDwarvenFortressOilCasks
		WhichSpecialWeapon		= 1

		UnpackTime              = 4600 
		PackTime                = 4600
		
		SpecialWeapon			= DwarvenFortressOilCasksWeapon
	End

	Behavior = AudioLoopUpgrade ModuleTag_OilCasksBuildLoop
		; Play a "build loop" while the Mighty Catapult is building up
		TriggeredBy			= Upgrade_DwarvenFortressOilCasks
		;ConflictsWith		= 
		SoundToPlay			= BuildingConstructionLoop
		KillOnDeath         = Yes
		KillAfterMS			= 2500
		RequiresAllTriggers = Yes
	End
	
	Behavior = ModelConditionUpgrade ModuleTag_ShowTheOil
		TriggeredBy				= Upgrade_DwarvenFortressOilCasks
		AddConditionFlags		= FORTRESS_IMPROVEMENT_2
		AddTempConditionFlag	= ModelConditionState:USER_3 //For buildup
		TempConditionTime		= 8.0						 //try to match buildup anim time
	End

	Behavior = SubObjectsUpgrade ModuleTag_ShowCasks
		TriggeredBy		= Upgrade_DwarvenFortressOilCasks
		ShowSubObjects		= DBFRBARREL
	End

	Behavior = AutoAbilityBehavior ModuleTag_AutoAbilityMurderOfCrowsBehavior	
		SpecialAbility		= SpecialAbilityDwarvenFortressOilCasks					;// Use this ability
	End
	
	// Dwarven Stonework improvement, just an upgrade
	Behavior = CastleUpgrade ModuleTag_PassOutDwarvenStoneworkUpgrade
		TriggeredBy		= Upgrade_DwarvenFortressDwarvenStoneworkTrigger
		Upgrade			= Upgrade_DwarvenFortressDwarvenStonework
		WallUpgradeRadius 	= MEN_FORTRESS_WALL_EFFECTIVE_RADIUS
	End
																						  
	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy		= Upgrade_DwarvenFortressDwarvenStonework
		AttributeModifier	= DwarvenStoneworkKeep_Bonus
	End

	Behavior = ModelConditionUpgrade ModuleTag_ShowTheStones
		TriggeredBy		= Upgrade_DwarvenFortressDwarvenStonework		
		AddConditionFlags	= UPGRADE_NUMENOR_STONEWORK
		Permanent		= Yes
	End

	// Flaming Munitions improvement, just an upgrade, but doesn't do anything for us.
	Behavior = ModelConditionUpgrade ModuleTag_ShowFlamingMunitions
		TriggeredBy		= Upgrade_GoodFortressFlamingMunitionsTrigger
		AddConditionFlags	= FORTRESS_IMPROVEMENT_1
		AddTempConditionFlag	= ModelConditionState:USER_2 			//For buildup
		TempConditionTime	= 8.0						//try to match buildup anim time
	End
	Behavior = CastleUpgrade ModuleTag_PassOutFlamingMunitionsUpgrade
		TriggeredBy		= Upgrade_GoodFortressFlamingMunitionsTrigger
		Upgrade			= Upgrade_GoodFortressFlamingMunitions
	End

	Behavior = AudioLoopUpgrade ModuleTag_FlamingMunitionsBuildLoop
		; Play a "build loop" while the Mighty Catapult is building up
		TriggeredBy		= Upgrade_GoodFortressFlamingMunitionsTrigger
		;ConflictsWith		= 
		SoundToPlay		= BuildingConstructionLoop
		KillOnDeath         	= Yes
		KillAfterMS		= 3500
		RequiresAllTriggers 	= Yes
	End


	Behavior = StatusBitsUpgrade ModuleTag_FakeOut ;// I need to react to the upgrade, so I can have it for when new construction asks me for all the upgrades
		TriggeredBy		= Upgrade_GoodFortressFlamingMunitions
	End

;// No subobject for the torches right now.	
;//	Behavior = SubObjectsUpgrade ModuleTag_ShowTorches
;//		TriggeredBy		= Upgrade_GoodFortressFlamingMunitions
;//		ShowSubObjects		= GBFFLAMING
;//	End
	
	// Banners improvement, the half that gives an aura bonus, not the purchase discount part (that is in the ProductionUpdate)
	Behavior = AttributeModifierAuraUpdate ModuleTag_BannerLeadership
		StartsActive		= No ;If no, requires upgrade to turn on.
		BonusName		= DwarvenFortressBannersLeadership
		TriggeredBy		= Upgrade_DwarvenFortressBanners
		RefreshDelay		= 2000
		Range			= 300
		ObjectFilter		= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
	End	

	Behavior = SubObjectsUpgrade ModuleTag_ShowBanners
		TriggeredBy		= Upgrade_DwarvenFortressBanners
		ShowSubObjects		= DBFBANNER
	End
	
	// Siege Kegs improvement (Addes 1k HP to fortress, and heals units in the area)
	Behavior = SubObjectsUpgrade ModuleTag_ShowKegs
		TriggeredBy		= Upgrade_DwarvenFortressSiegeKegs
		ShowSubObjects		= DBFSKEGS
	End

	Behavior = AttributeModifierUpgrade ModuleTag_KegsBonus
		TriggeredBy		= Upgrade_DwarvenFortressSiegeKegs
		AttributeModifier	= SiegeKegsKeep_Bonus
	End

	Behavior = PassiveAreaEffectBehavior ModuleTag_MysticFountainsHealing
		UpgradeRequired		= Upgrade_DwarvenFortressSiegeKegs
		EffectRadius		= 200 		// please update the decal size in experience lvl INI if you change this... the value there is about 2.2x the value here		
		PingDelay		= 2000;msec
		HealPercentPerSecond	= 3%
		AllowFilter		= ANY +INFANTRY +CAVALRY +HERO -MACHINE +MONSTER -IMMOBILE +DOZER
		NonStackable		= Yes
		HealFX			= FX_SpellHealUnitHealBuff
	End

	Behavior = BannerCarrierUpdate BannerCarrierUpdateModuleTag
		UpgradeRequired			= Upgrade_DwarvenFortressSiegeKegs
		IdleSpawnRate			= 5000							// spawn a new member every n seconds when idle (in miliseconds)		
		UnitSpawnFX				= FX_BannerCarrierSpawnUnit		// name of particle FX to use when the BannerCarrier spawns a new unit		

		// This well object acts like a banner carrier except it spawns unit on nearby hordes instead of itself.
		ReplenishNearbyHorde	= Yes
		ScanHordeDistance		= 200
	End

	//Mighty Catapult	
	Behavior = ModelConditionUpgrade ModuleTag_ShowTheTower
		TriggeredBy = Upgrade_DwarvenFortressMightyCatapult Upgrade_DwarvenFortressDwarvenStonework
		RequiresAllTriggers = Yes
		AddConditionFlags = UPGRADE_FORTRESS_MONUMENT
		AddTempConditionFlag	= ModelConditionState:USER_1 //For buildup
		TempConditionTime		= 10.0						 //try to match buildup anim time
	End

	//Delay the button being available with this little trick wait some time before granting the upgrade to allow for buildup.
	Behavior = ObjectCreationUpgrade CatapultReady
		TriggeredBy			= Upgrade_DwarvenFortressMightyCatapult Upgrade_DwarvenFortressDwarvenStonework
		RequiresAllTriggers	= Yes		
		Delay				= 8500
		GrantUpgrade		= Upgrade_DwarvenFortressMightyCatapultReady
	End

	Behavior = AudioLoopUpgrade ModuleTag_MightyCatapultBuildLoop
		; Play a "build loop" while the Mighty Catapult is building up
		TriggeredBy			= Upgrade_DwarvenFortressMightyCatapult Upgrade_DwarvenFortressDwarvenStonework
		;ConflictsWith		= 
		SoundToPlay			= BuildingBigConstructionLoop		;BuildingConstructionLoop
		KillOnDeath         = Yes
		KillAfterMS			= 8500
		RequiresAllTriggers = Yes
	End
	
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_CatapultEnabler
		SpecialPowerTemplate	= SpecialAbilityMightyCatapultLauncher
		TriggeredBy				= Upgrade_DwarvenFortressMightyCatapultReady
	End

	Behavior = SpecialPowerModule ModuleTag_CatapultStarter       
		SpecialPowerTemplate		= SpecialAbilityMightyCatapultLauncher
		UpdateModuleStartsAttack	= Yes
		StartsPaused		  		= Yes
		InitiateSound				= MightyCatapultStarterMS		
	End
	Behavior = WeaponFireSpecialAbilityUpdate ModuleTag_SpireWeaponFireUpdate   
		SpecialPowerTemplate    = SpecialAbilityMightyCatapultLauncher
		WhichSpecialWeapon		= 1

		UnpackTime              = 10 
		PackTime                = 10
		SpecialWeapon			= DwarvenMightyCatapultFortressWeapon
		TriggerSound			= MightyCatapultRotateMS
		ApproachRequiresLOS		= No
	End

	Behavior = AutoAbilityBehavior ModuleTag_AutoAbilityLightningBehavior	
		SpecialAbility				= SpecialAbilityMightyCatapultLauncher				// Use this ability
	End

	Behavior = GeometryUpgrade ModueTag_CatapultGeom
		TriggeredBy			= Upgrade_DwarvenFortressMightyCatapult Upgrade_DwarvenFortressDwarvenStonework
;		ConflictsWith		= Upgrade_PosternGate Upgrade_OpenGarrison
		RequiresAllTriggers = Yes
;		ShowGeometry		= TrebGeom
;		HideGeometry		= TowerGeom DummyGeom
		WallBoundsMesh		= P1
	End

	Behavior = ObjectCreationUpgrade FirstCatapult
		TriggeredBy			= Upgrade_DwarvenFortressMightyCatapult Upgrade_DwarvenFortressDwarvenStonework
		RequiresAllTriggers	= Yes		
		Delay				= 9000
		ThingToSpawn		= DwarvenFortressMightyCatapult
		Offset				= X:0.0 Y:0.0 Z:155.0
		FadeInTime			= 600
	End
	Behavior = SlaveWatcherBehavior WatchTheTreb		
	End
	
	Behavior = GeometryUpgrade TowerGeom
		TriggeredBy			= Upgrade_DwarvenFortressMightyCatapult Upgrade_DwarvenFortressDwarvenStonework
		RequiresAllTriggers	= Yes
		ShowGeometry		= HighTowerGeom
	End
	
	Behavior = AIUpdateInterface ModuleTag_AI
		AILuaEventsList				= FortressFunctions
		AutoAcquireEnemiesWhenIdle	= Yes
		MoodAttackCheckRate			= 250
	End

	;//Money Maker
	Behavior = AutoDepositUpdate AutoDepositModuleTag
		DepositTiming       	= GENERIC_KEEP_MONEY_TIME
		DepositAmount       	= GENERIC_KEEP_MONEY_AMOUNT 
		InitialCaptureBonus 	= 0  ;// no initial bonus
	End

	Behavior = TerrainResourceBehavior ModuleTag_NewMoneyDeadSpot
		Radius			= GENERIC_KEEP_MONEY_RANGE	;// How far we try to claim ground
		MaxIncome		= 0							;// If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval	= 999999					;// How often (in msec) we give that much money
		HighPriority	= Yes						;// A high priority claim gets to pretend it was there first.
		Visible = No 		;// Don't show decal when a resource building is selected.
	End
	
	#include "..\..\..\FortressRingFunc.inc"
	
	Geometry              	= BOX
	GeometryMajorRadius   	= 66
	GeometryMinorRadius   	= 50
	GeometryHeight        	= 60
	
	//Main
	AdditionalGeometry		= BOX
	GeometryMajorRadius   	= 16
	GeometryMinorRadius   	= 14
	GeometryHeight        	= 115
	GeometryOffset			= X:-38 Y:-38 Z:0	

	//Towers
	AdditionalGeometry		= BOX
	GeometryMajorRadius   	= 16
	GeometryMinorRadius   	= 14
	GeometryHeight        	= 115
	GeometryOffset			= X:35 Y:-38 Z:0	

	AdditionalGeometry		= BOX
	GeometryMajorRadius   	= 16
	GeometryMinorRadius   	= 14
	GeometryHeight        	= 115
	GeometryOffset			= X:-38 Y:38 Z:0	

	AdditionalGeometry		= BOX
	GeometryMajorRadius   	= 16
	GeometryMinorRadius   	= 14
	GeometryHeight        	= 115
	GeometryOffset			= X:35 Y:38 Z:0	

	//Front and back
	AdditionalGeometry		= BOX
	GeometryMajorRadius   	= 12
	GeometryMinorRadius   	= 30
	GeometryHeight        	= 50
	GeometryOffset			= X:78 Y:0 Z:0	

	AdditionalGeometry		= BOX
	GeometryMajorRadius   	= 12
	GeometryMinorRadius   	= 30
	GeometryHeight        	= 50
	GeometryOffset			= X:-78 Y:0 Z:0
	
	AdditionalGeometry		= BOX
	GeometryName			= HighTowerGeom
	GeometryMajorRadius   	= 12
	GeometryMinorRadius   	= 12
	GeometryHeight        	= 150
	GeometryOffset			= X:0 Y:0 Z:0
	GeometryUsedForHealthBox = No
	
	GeometryIsSmall       	= No	
	Shadow                	= SHADOW_VOLUME
	BuildCompletion			= PLACED_BY_PLAYER
	
	GeometryContactPoint = X:-104	Y:79	Z:0			Repair
	GeometryContactPoint = X:41		Y:-42	Z:0
	GeometryContactPoint = X:41		Y:-42	Z:45
	GeometryContactPoint = X:-41	Y:-42	Z:45
	GeometryContactPoint = X:-41	Y:-42	Z:0
	GeometryContactPoint = X:-80	Y:0		Z:0
	GeometryContactPoint = X:-80	Y:0		Z:45
	GeometryContactPoint = X:-41	Y:42	Z:45
	GeometryContactPoint = X:-41	Y:42	Z:0
	GeometryContactPoint = X:41		Y:42	Z:0
	GeometryContactPoint = X:41		Y:42	Z:45
	GeometryContactPoint = X:80		Y:0		Z:45
	GeometryContactPoint = X:80		Y:0		Z:0
	GeometryContactPoint = X:0		Y:0		Z:180		Swoop
End

//------------------------------------------------------------------------------
// This is the one object that you would place on a map and that the porter builds.
// It unpacks in to the citadel and the buildplots.  It's an old CampFlag.
Object DwarvenFortress	

	SelectPortrait = BPDFortress
	
	Draw   = W3DScriptedModelDraw ModuleTag_01
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		IdleAnimationState
		End

		//Need this since the default condition is none
		ModelConditionState = WORLD_BUILDER
			Model	= DBFortress
		End

		//Phantom structure when placing a new building to be build
		ModelConditionState = BUILD_PLACEMENT_CURSOR
			Model	= None	//DBFortress
		End

		//Structure that stays where you will be building until the porter reaches the place to start building.
		ModelConditionState =  PHANTOM_STRUCTURE
			Model	= DBFortress
		End

		;//	Animation state for build placement cursor
		AnimationState = BUILD_PLACEMENT_CURSOR
			BeginScript
   				CurDrawableHideSubObject("DBFBANNER")
   				CurDrawableHideSubObject("DBFSKEGS")
			EndScript
		End
		
		;//	Animation state for phantom structure
		AnimationState = PHANTOM_STRUCTURE
			BeginScript
   				CurDrawableHideSubObject("DBFBANNER")
   				CurDrawableHideSubObject("DBFSKEGS")
			EndScript
		End
		
		ModelConditionState  = RUBBLE
			Model			= DBFortress_D3						
		End
    
		AnimationState	= RUBBLE
			Animation	= Fortress_ReallyDamaged
				AnimationName		= DBFortress_D3SK.DBFortress_D3AN
				AnimationMode		= ONCE				
			End	
			EnteringStateFX	= FX_FortressCollapse		
		End
				
		ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED ;//UNPACKING
			Model	= DBFortress_A		
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End 
		
		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED ;//UNPACKING
			Model			= DBFortress_A			
		End

		AnimationState = ACTIVELY_BEING_CONSTRUCTED
			Animation					= UpAndStill
				AnimationName			= DBFortress_ASK.DBFortress_ABL
				AnimationMode			= MANUAL
			End			
			ParticleSysBone = NONE BuildingContructDustCastles FollowBone:YES
			ParticleSysBone = NONE FortressDwarves FollowBone:YES
			StateName		= BeingConstructed
			BeginScript
				CurDrawablePlaySound("GondorBarracksBeginConstruction")
			EndScript
		End
	End

	//Door
	Draw = W3DScriptedModelDraw ModuleTag_DrawDoor
	     
		DefaultModelConditionState
			Model = None
		End

		//---Build Up---
		ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED
			Model               = DBFDoor_A
		End
	    
		AnimationState        = ACTIVELY_BEING_CONSTRUCTED
			Animation           = DBFDoor_A
				AnimationName     = DBFDoor_A.DBFDoor_A
				AnimationMode     = MANUAL
			End
		End
	End
	
	ArmorSet
		Conditions      = None
		Armor           = FortressArmor
		DamageFX        = EmptyDamageFX   ;// just to avoid an assert
	End

	Side                = Dwarves
	EditorSorting       = STRUCTURE

	PlacementViewAngle	= -45 ;// A -90 makes the door of the base face natural south.  0 would have it to the East.
	
	BuildCost           = DWARVEN_FORTRESS_BUILDCOST
	BuildTime           = DWARVEN_FORTRESS_BUILDTIME           ;// in seconds


	// *** AUTO RESOLVE DATA ***
	// When fighting an auto-resolve battle, a World Map castle actually becomes this unit
	AutoResolveUnitType = AutoResolveUnit_Fortress
    
    	AutoResolveBody = AutoResolve_DwarvenFortressBody
    
    	AutoResolveArmor
    		Armor = AutoResolve_DwarvenFortressArmor
    	End

    	AutoResolveWeapon
    		Weapon = AutoResolve_DwarvenFortressWeapon
    	End

	DisplayName         = OBJECT:DwarvenFortress
	
	// *** AUDIO Parameters ***

	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	VoiceSelect						= DwarvenFortressSelect

	SoundOnDamaged					= BuildingLightDamageStone
	SoundOnReallyDamaged			= BuildingHeavyDamageStone

	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction
	VoiceFullyCreated				= EVA:FortressComplete-Builder-Dwarf

	UnitSpecificSounds
		UnderConstruction			= BuildingBigConstructionLoop	;// Built first time
		;UnderRepairFromDamage		= NoSound							;// Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble		= BuildingBigConstructionLoop	;// Repaired from completely destroyed (not used???)
	End

	ClientBehavior = ModelConditionAudioLoopClientBehavior ModuleTag_PlayCollapseSound
		ModelCondition = REQUIRED:RUBBLE Sound:BuildingSink
	End

	// *** ENGINEERING Parameters ***  
	RadarPriority       = STRUCTURE
	KindOf              = STRUCTURE SELECTABLE IMMOBILE BASE_FOUNDATION MP_COUNT_FOR_VICTORY BASE_SITE CAN_SEE_THROUGH_STRUCTURE LIVING_WORLD_BUILDING_MIRROR	
	
	Body                = StructureBody ModuleTag_05
		MaxHealth					= DWARVEN_FORTRESS_HEALTH	
	End
	  
	Behavior = CastleBehavior ModuleTag_castle
  		//This refers to the side and name of the .BSE file used to unapck the fortress
		CastleToUnpackForFaction	= Dwarves Fortress_Dwarven
		CastleToUnpackForFaction	= Elves Fortress_Dwarven
		CastleToUnpackForFaction	= Men Fortress_Dwarven
		CastleToUnpackForFaction	= Wild Fortress_Dwarven
		CastleToUnpackForFaction	= Isengard Fortress_Dwarven
		CastleToUnpackForFaction	= Mordor Fortress_Dwarven
		CastleToUnpackForFaction	= Angmar Fortress_Dwarven
		CastleToUnpackForFaction	= Arnor Fortress_Dwarven

		//Anything that does not fit this filter will be given to the neutral player, so the template can have rocks and props.
		FilterValidOwnedEntries		= ANY +STRUCTURE +WALK_ON_TOP_OF_WALL +BASE_FOUNDATION +TACTICAL_MARKER		

		MaxCastleRadius 			= 130.0
		InstantUnpack				= Yes
		KeepDeathKillsEverything	= Yes		
		UnpackDelayTime				= 0.0

		EvaEnemyCastleSightedEvent = EnemyFortressSighted
	End  
		  
	Behavior = StructureCollapseUpdate ModuleTag_Collapse
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_StructureMediumCollapse
		FXList                  = ALMOST_FINAL  FX_StructureAlmostCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight			= 120
	End
  
	Behavior            = GettingBuiltBehavior ModuleTag_GettingBuiltBehavior
		WorkerName	= DwarvenWorkerNoSelect
		SpawnTimer	= DEFAULT_STRUCTURE_HEALDELAY
	End

	Behavior = AIUpdateInterface ModuleTag_AI
		AILuaEventsList		=	FortressFunctions
	End
	
	//Main
	Geometry              	= BOX
	GeometryMajorRadius   	= 81
	GeometryMinorRadius   	= 65
	GeometryHeight        	= 60

	//Plot locations
	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:94.80 Y:-61.75 Z:0	

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:0 Y:-90.0 Z:0	

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:-94.80 Y:-61.75 Z:0	

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:-94.80 Y:61.75 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:0 Y:90.0 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:94.80 Y:61.75 Z:0

	GeometryIsSmall			= No
	Shadow					= SHADOW_VOLUME

	GeometryContactPoint = X:-104	Y:79	Z:0			Repair
End
